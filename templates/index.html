<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thomson Reuters Analytics Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Thomson Reuters Brand Colors */
        :root {
            --tr-orange: #FF6200;
            --tr-dark-blue: #0F1419;
            --tr-light-blue: #0073E6;
            --tr-gray-dark: #2C2C2C;
            --tr-gray-medium: #5A5A5A;
            --tr-gray-light: #F5F5F5;
            --tr-white: #FFFFFF;
            --tr-success: #00A651;
            --tr-warning: #FFB81C;
            --tr-danger: #E31837;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--tr-gray-light);
        }
        
        .metric-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: var(--tr-white);
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(15, 20, 25, 0.1);
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(15, 20, 25, 0.15);
            border-color: var(--tr-orange);
        }
        
        .metric-card .card-title {
            color: var(--tr-orange);
            font-weight: 700;
            font-size: 2rem;
        }
        
        .metric-card .card-text {
            color: var(--tr-gray-medium);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }
        
        .chart-container {
            background: var(--tr-white);
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(15, 20, 25, 0.08);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #E0E0E0;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--tr-white) !important;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--tr-dark-blue) 0%, var(--tr-gray-dark) 100%) !important;
            box-shadow: 0 2px 12px rgba(15, 20, 25, 0.15);
        }
        
        .sidebar {
            background: linear-gradient(180deg, var(--tr-white) 0%, #FAFAFA 100%);
            min-height: 100vh;
            padding: 24px;
            border-right: 1px solid #E0E0E0;
        }
        
        .sidebar h5 {
            color: var(--tr-dark-blue);
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--tr-orange);
        }
        
        .main-content {
            padding: 24px;
            background: var(--tr-gray-light);
        }
        
        .metric-selector {
            background: var(--tr-white);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(15, 20, 25, 0.06);
            border: 1px solid #E0E0E0;
            transition: all 0.3s ease;
        }
        
        .metric-selector:hover {
            box-shadow: 0 4px 16px rgba(15, 20, 25, 0.1);
            border-color: var(--tr-orange);
        }
        
        .metric-selector h6 {
            color: var(--tr-dark-blue);
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .client-token-info {
            background: linear-gradient(135deg, #E6F3FF 0%, #F0F8FF 100%);
            border-left: 4px solid var(--tr-light-blue);
            padding: 16px;
            margin-bottom: 20px;
            border-radius: 6px;
            color: var(--tr-dark-blue);
        }
        
        .github-info {
            background: linear-gradient(135deg, #F5F5F5 0%, #FAFAFA 100%);
            border-left: 4px solid var(--tr-gray-dark);
            padding: 16px;
            margin-bottom: 20px;
            border-radius: 6px;
            color: var(--tr-dark-blue);
        }
        
        .azuredevops-info {
            background: linear-gradient(135deg, #E6F3FF 0%, #F0F8FF 100%);
            border-left: 4px solid var(--tr-light-blue);
            padding: 16px;
            margin-bottom: 20px;
            border-radius: 6px;
            color: var(--tr-dark-blue);
        }
        
        .figma-info {
            background: linear-gradient(135deg, #FFF4E6 0%, #FFF8F0 100%);
            border-left: 4px solid var(--tr-orange);
            padding: 16px;
            margin-bottom: 20px;
            border-radius: 6px;
            color: var(--tr-dark-blue);
        }
        
        .nav-tabs {
            border-bottom: 2px solid var(--tr-orange);
            margin-bottom: 24px;
        }
        /* Datadog Theme - Matching Existing Dashboard Style */
        .datadog-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .datadog-search-container {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .datadog-stats-container {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .datadog-logs-container {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .datadog-info h5,
        .datadog-search-container h5,
        .datadog-stats-container h4,
        .datadog-logs-container h4 {
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .datadog-info h5 i {
            color: #2196f3;
        }
        
        .datadog-search-container h5 i {
            color: #9c27b0;
        }
        
        .datadog-stats-container h4 i {
            color: #4caf50;
        }
        
        .datadog-logs-container h4 i {
            color: #ff9800;
        }
        
        .datadog-info p {
            margin-bottom: 8px;
            color: #555;
        }
        
        .datadog-info span {
            font-weight: 500;
            color: #2196f3;
        }
        
        .datadog-search-container .form-label {
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .datadog-search-container .form-control,
        .datadog-search-container .form-select {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 12px;
            transition: all 0.3s ease;
        }
        
        .datadog-search-container .form-control:focus,
        .datadog-search-container .form-select:focus {
            border-color: #9c27b0;
            box-shadow: 0 0 0 0.2rem rgba(156, 39, 176, 0.25);
        }
        
        .datadog-search-container .btn-primary {
            background: #9c27b0;
            border: none;
            color: white;
            border-radius: 4px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .datadog-search-container .btn-primary:hover {
            background: #7b1fa2;
        }
        
        .datadog-stats-container .card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .datadog-stats-container .card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .datadog-stats-container .card-body {
            color: #333;
            padding: 15px;
        }
        
        .datadog-stats-container .badge {
            background: #4caf50;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .datadog-logs-container .table {
            background: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .datadog-logs-container .table thead th {
            background: #ff9800;
            color: white;
            border: none;
            font-weight: 600;
            padding: 12px;
        }
        
        .datadog-logs-container .table tbody tr {
            transition: all 0.3s ease;
        }
        
        .datadog-logs-container .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .datadog-logs-container .table tbody td {
            padding: 10px 12px;
            border: none;
            border-bottom: 1px solid #e9ecef;
        }
        
        .datadog-logs-container .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
            font-size: 0.75rem;
        }
        .datadog-logs-container .alert {
            border: none;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .nav-tabs .nav-link {
            color: var(--tr-gray-medium);
            font-weight: 500;
            border: none;
            border-radius: 6px 6px 0 0;
            margin-right: 4px;
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link:hover {
            color: var(--tr-dark-blue);
            background-color: #F8F8F8;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--tr-white) !important;
            background: linear-gradient(135deg, var(--tr-orange) 0%, #E55A00 100%);
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(255, 98, 0, 0.3);
        }
        
        /* Welcome Modal Styles - Thomson Reuters */
        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 12px 40px rgba(15, 20, 25, 0.2);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--tr-dark-blue) 0%, var(--tr-gray-dark) 100%);
            border-radius: 12px 12px 0 0;
            border-bottom: none;
            padding: 24px 32px;
            color: var(--tr-white);
        }
        
        .modal-header .modal-title {
            font-weight: 700;
            color: var(--tr-white);
        }
        
        .modal-body {
            padding: 32px;
            background: var(--tr-white);
        }
        
        .modal-footer {
            border-top: 1px solid #E0E0E0;
            padding: 24px 32px;
            background: #FAFAFA;
            border-radius: 0 0 12px 12px;
        }
        
        .welcome-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            border: 2px solid #E0E0E0;
            background: var(--tr-white);
        }
        
        .welcome-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(15, 20, 25, 0.1);
            border-color: var(--tr-orange);
        }
        
        .welcome-card.selected {
            border-color: var(--tr-orange);
            background: linear-gradient(135deg, #FFF4E6 0%, #FFF8F0 100%);
            box-shadow: 0 4px 16px rgba(255, 98, 0, 0.15);
        }
        
        /* Toast Notifications - Thomson Reuters */
        .toast {
            border-radius: 8px;
            border: none;
            box-shadow: 0 4px 16px rgba(15, 20, 25, 0.15);
        }
        
        .toast-header {
            background: var(--tr-white);
            border-bottom: 1px solid #E0E0E0;
        }
        
        /* Project Setup Form Styles - Thomson Reuters */
        #projectSetupForm .form-label {
            font-weight: 600;
            color: var(--tr-dark-blue);
            margin-bottom: 8px;
        }
        
        #projectSetupForm .form-label i {
            margin-right: 8px;
            color: var(--tr-orange);
        }
        
        #projectSetupForm .form-control,
        #projectSetupForm .form-select {
            border-radius: 6px;
            border: 1px solid #D0D0D0;
            padding: 12px 16px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            font-size: 0.9rem;
        }
        
        #projectSetupForm .form-control:focus,
        #projectSetupForm .form-select:focus {
            border-color: var(--tr-orange);
            box-shadow: 0 0 0 0.2rem rgba(255, 98, 0, 0.15);
            outline: none;
        }
        
        #projectSetupForm .form-text {
            font-size: 0.75rem;
            color: var(--tr-gray-medium);
        }
        
        /* Button Styles - Thomson Reuters */
        .btn-primary {
            background: linear-gradient(135deg, var(--tr-orange) 0%, #E55A00 100%);
            border: none;
            border-radius: 6px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 98, 0, 0.25);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #E55A00 0%, #CC5200 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 98, 0, 0.35);
        }
        
        .btn-outline-secondary {
            border: 1px solid var(--tr-gray-medium);
            color: var(--tr-gray-medium);
            border-radius: 6px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-outline-secondary:hover {
            background: var(--tr-gray-medium);
            border-color: var(--tr-gray-medium);
            color: var(--tr-white);
        }
        
        .btn-outline-light {
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--tr-white);
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-outline-light:hover {
            background: var(--tr-orange);
            border-color: var(--tr-orange);
            color: var(--tr-white);
        }
        
        /* Alert Styles - Thomson Reuters */
        .alert-info {
            background: linear-gradient(135deg, #E6F3FF 0%, #F0F8FF 100%);
            border: 1px solid var(--tr-light-blue);
            color: var(--tr-dark-blue);
            border-radius: 6px;
        }
        
        .alert-info i {
            color: var(--tr-light-blue);
        }
        
        /* Welcome Screen Styles */
        .welcome-hero {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .welcome-setup-card {
            border: 1px solid #E0E0E0;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(15, 20, 25, 0.08);
            transition: all 0.3s ease;
        }
        
        .welcome-setup-card:hover {
            box-shadow: 0 8px 30px rgba(15, 20, 25, 0.12);
            border-color: var(--tr-orange);
        }
        
        .setup-steps {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .setup-step {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #FAFAFA 0%, #FFFFFF 100%);
            border-radius: 8px;
            border: 1px solid #F0F0F0;
            transition: all 0.3s ease;
        }
        
        .setup-step:hover {
            border-color: var(--tr-orange);
            box-shadow: 0 2px 12px rgba(255, 98, 0, 0.1);
        }
        
        .step-number {
            background: linear-gradient(135deg, var(--tr-orange) 0%, #E55A00 100%);
            color: var(--tr-white);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(255, 98, 0, 0.3);
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-content h6 {
            color: var(--tr-dark-blue);
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .step-content p {
            margin-bottom: 12px;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .setup-steps {
                gap: 16px;
            }
            
            .setup-step {
                padding: 16px;
            }
            
            .welcome-hero h2 {
                font-size: 1.75rem;
            }
            
            .welcome-hero .lead {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-chart-line"></i> Thomson Reuters Analytics
            </span>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-light btn-sm me-3" onclick="showWelcomeModal()" title="Show Project Setup">
                    <i class="fas fa-cog"></i> Project Setup
                </button>
                <span class="navbar-text">
                    <i class="fas fa-building"></i> Enterprise Analytics Platform
                </span>
            </div>
        </div>
    </nav>

    <!-- Welcome Modal -->
    <div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="welcomeModalLabel">
                        <i class="fas fa-building"></i> Thomson Reuters Project Setup
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="fab fa-microsoft fa-3x mb-3" style="color: var(--tr-orange);"></i>
                        <h4 style="color: var(--tr-dark-blue);">Azure DevOps Configuration</h4>
                        <p class="text-muted">Configure your project settings to start analyzing your development metrics</p>
                    </div>
                    
                    <form id="projectSetupForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="setupOrgName" class="form-label">
                                        <i class="fas fa-building"></i> Organization Name
                                </label>
                                    <input type="text" class="form-control" id="setupOrgName" placeholder="e.g., tr-tax" required>
                                    <div class="form-text">Your Azure DevOps organization name</div>
                            </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="setupProjectName" class="form-label">
                                        <i class="fas fa-project-diagram"></i> Project Name
                                </label>
                                    <input type="text" class="form-control" id="setupProjectName" placeholder="e.g., TaxProf" required>
                                    <div class="form-text">Your Azure DevOps project name</div>
                            </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="setupAreaPath" class="form-label">
                                        <i class="fas fa-sitemap"></i> Area Path
                                </label>
                                    <input type="text" class="form-control" id="setupAreaPath" placeholder="e.g., TaxProf\\us\\taxAuto\\ADGE\\Prep">
                                    <div class="form-text">Area path to filter work items (optional)</div>
                            </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="setupTimeRange" class="form-label">
                                        <i class="fas fa-calendar-alt"></i> Time Range
                                </label>
                                    <select class="form-select" id="setupTimeRange">
                                        <option value="7">Last 7 days</option>
                                        <option value="30" selected>Last 30 days</option>
                                        <option value="90">Last 90 days</option>
                                    </select>
                            </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Note:</strong> Make sure you have a valid Azure DevOps Personal Access Token (PAT) configured in the system. You can update these settings later from the Azure DevOps tab.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="skipSetup()">
                        <i class="fas fa-times"></i> Skip Setup
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveProjectSetup()">
                        <i class="fas fa-save"></i> Save & Continue
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="welcomeModalLabel">
                        <i class="fas fa-building"></i> Thomson Reuters Project Setup
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="fab fa-microsoft fa-3x mb-3" style="color: var(--tr-orange);"></i>
                        <h4 style="color: var(--tr-dark-blue);">Azure DevOps Configuration</h4>
                        <p class="text-muted">Configure your project settings to start analyzing your development metrics</p>
                    </div>
                    
                    <form id="projectSetupForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="setupOrgName" class="form-label">
                                        <i class="fas fa-building"></i> Organization Name
                                </label>
                                    <input type="text" class="form-control" id="setupOrgName" placeholder="e.g., tr-tax" required>
                                    <div class="form-text">Your Azure DevOps organization name</div>
                            </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="setupProjectName" class="form-label">
                                        <i class="fas fa-project-diagram"></i> Project Name
                                </label>
                                    <input type="text" class="form-control" id="setupProjectName" placeholder="e.g., TaxProf" required>
                                    <div class="form-text">Your Azure DevOps project name</div>
                            </div>
                        </div>
                    </div>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="setupAreaPath" class="form-label">
                                        <i class="fas fa-sitemap"></i> Area Path
                                    </label>
                                    <input type="text" class="form-control" id="setupAreaPath" placeholder="e.g., TaxProf\\us\\taxAuto\\ADGE\\Prep">
                                    <div class="form-text">Area path to filter work items (optional)</div>
                    </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="setupTimeRange" class="form-label">
                                        <i class="fas fa-calendar-alt"></i> Time Range
                                    </label>
                                    <select class="form-select" id="setupTimeRange">
                                        <option value="7">Last 7 days</option>
                                        <option value="30" selected>Last 30 days</option>
                                        <option value="90">Last 90 days</option>
                        </select>
                    </div>
                            </div>
                    </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Note:</strong> Make sure you have a valid Azure DevOps Personal Access Token (PAT) configured in the system. You can update these settings later from the Azure DevOps tab.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="skipSetup()">
                        <i class="fas fa-times"></i> Skip Setup
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveProjectSetup()">
                        <i class="fas fa-save"></i> Save & Continue
                    </button>
                </div>
            </div>
        </div>
                </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar">

                <!-- GitHub Configuration -->
                <div id="github-sidebar" style="display: none;">
                    <h5><i class="fab fa-github"></i> GitHub Configuration</h5>
                    
                    <div class="github-info">
                        <small><strong>GitHub Integration:</strong> Multi-Repository Analytics</small><br>
                        <small><strong>Active Repos:</strong> <span id="github-repo-info">None configured</span></small>
                    </div>

                    <div class="metric-selector">
                        <h6><i class="fab fa-github"></i> Add Repository</h6>
                        <div class="row">
                            <div class="col-12">
                                <label for="github-repo-input" class="form-label">Repository (owner/repo format):</label>
                                <input type="text" class="form-control mb-2" id="github-repo-input" 
                                       placeholder="e.g., microsoft/vscode or tr/cs-prof-cloud_ultratax-api-services"
                                       onkeypress="if(event.key === 'Enter') addGitHubRepo()">
                            </div>
                            <div class="col-12">
                                <button class="btn btn-outline-success w-100 mb-2" onclick="addGitHubRepo()">
                                    <i class="fas fa-plus"></i> Add Repository
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="metric-selector">
                        <h6><i class="fas fa-sync-alt"></i> Azure DevOps Integration</h6>
                        <button class="btn btn-outline-info w-100 mb-2" id="sync-azure-devops-btn" onclick="syncRepositoriesFromAzureDevOps()">
                            <i class="fab fa-microsoft"></i> <i class="fas fa-arrow-right"></i> <i class="fab fa-github"></i> 
                            Sync from Azure DevOps
                                </button>
                        <small class="text-muted">Load repositories from Azure DevOps work items</small>
                            </div>

                    <div class="metric-selector">
                        <h6><i class="fas fa-list"></i> Selected Repositories</h6>
                        <div id="selected-repos" class="mb-2">
                            <small class="text-muted">No repositories selected</small>
                        </div>
                        <button class="btn btn-outline-danger btn-sm w-100" onclick="clearAllRepos()">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>

                    <div class="metric-selector">
                        <h6>Time Range</h6>
                        <select class="form-select" id="github-time-range">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                    </div>

                    <div class="metric-selector">
                        <h6>Chart Type</h6>
                        <select class="form-select" id="github-chart-type">
                            <option value="overview" selected>PR Status Overview</option>
                            <option value="prs_by_day">PRs by Day</option>
                            <option value="prs_by_author">PRs by Author</option>
                            <option value="summary">Repository Summary Table</option>
                        </select>
                    </div>

                    <button class="btn btn-primary w-100" id="github-update-btn" onclick="updateGitHubDashboard()">
                        <i class="fas fa-sync"></i> Update GitHub Analytics
                    </button>
                </div>

                <!-- Azure DevOps Configuration -->
                <div id="azuredevops-sidebar" style="display: block;">  <!-- Show by default since Azure DevOps is active tab -->
                    <h5><i class="fab fa-microsoft"></i> Azure DevOps Project Setup</h5>
                    
                    <div class="azuredevops-info">
                        <small><strong>Azure DevOps Integration:</strong> Work Items, Pull Requests & Builds</small><br>
                        <small><strong>Project:</strong> <span id="azuredevops-project-info">Not configured</span></small><br>
                        <small><strong>Area Path:</strong> <span id="azuredevops-area-info">Not specified</span></small>
                    </div>

                    <div class="metric-selector">
                        <h6><i class="fab fa-microsoft"></i> Project Setup</h6>
                        <div class="row">
                            <div class="col-12">
                                <label for="azuredevops-org" class="form-label">Organization Name:</label>
                                <input type="text" class="form-control mb-2" id="azuredevops-org" placeholder="e.g., mycompany">
                            </div>
                            <div class="col-12">
                                <label for="azuredevops-project" class="form-label">Project Name:</label>
                                <input type="text" class="form-control mb-2" id="azuredevops-project" placeholder="e.g., MyProject">
                            </div>
                            <div class="col-12">
                                <label for="azuredevops-area-path" class="form-label">Area Path (Optional):</label>
                                <input type="text" class="form-control mb-2" id="azuredevops-area-path" placeholder="e.g., MyProject\\Team\\Frontend">
                                <small class="form-text text-muted">Leave empty to use project root area</small>
                            </div>
                            <div class="col-12">
                                <button class="btn btn-outline-primary w-100" onclick="configureAzureDevOps()">
                                    <i class="fas fa-cog"></i> Configure
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="metric-selector">
                        <h6>Time Range</h6>
                        <select class="form-select" id="azuredevops-time-range">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                    </div>

                    <div class="metric-selector mt-3">
                        <h6>Analysis Mode</h6>
                        <select class="form-select" id="azuredevops-analysis-mode">
                            <option value="fast" selected>üöÄ Fast Mode (1-2 seconds)</option>
                            <option value="detailed">üîç Detailed Mode (includes PR/commit analysis)</option>
                        </select>
                        <small class="text-muted">Fast mode loads work items only. Detailed mode includes PR relations (~1 min).</small>
                    </div>
                    
                    <div class="metric-selector mt-3">
                        <h6>Chart Type</h6>
                        <select class="form-select" id="azuredevops-chart-type">
                            <option value="workitem-type" selected>üè∑Ô∏è Work Items by Type</option>
                            <option value="workitem-state">üìã Work Items by State</option>
                            <option value="workitem-assignee">üë§ Work Items by Assignee</option>
                        </select>
                        <small class="text-muted">Charts based on work item data (PR charts available after background loading)</small>
                    </div>

                    <button class="btn btn-primary w-100" onclick="updateAzureDevOpsDashboard()">
                        <i class="fas fa-sync"></i> Update Azure DevOps Analytics
                    </button>
                </div>

                <!-- Figma Configuration -->
                <div id="figma-sidebar" style="display: none;">
                    <h5><i class="fab fa-figma"></i> Figma Configuration</h5>
                    
                    <div class="figma-info">
                        <small><strong>Figma Integration:</strong> Design Files, Projects & Collaboration</small><br>
                        <small><strong>Team:</strong> <span id="figma-team-info">Not configured</span></small>
                    </div>

                    <div class="metric-selector">
                        <h6><i class="fab fa-figma"></i> Team Setup</h6>
                        <div class="row">
                            <div class="col-12">
                                <input type="text" class="form-control mb-2" id="figma-team-id" placeholder="Team ID">
                            </div>
                            <div class="col-12">
                                <button class="btn btn-outline-primary w-100" onclick="configureFigma()">
                                    <i class="fas fa-cog"></i> Configure
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="metric-selector">
                        <h6>Time Range</h6>
                        <select class="form-select" id="figma-time-range">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                    </div>

                    <div class="metric-selector">
                        <h6>Chart Type</h6>
                        <select class="form-select" id="figma-chart-type">
                            <option value="files_by_project" selected>Files by Project</option>
                            <option value="collaboration_activity">Collaboration Activity</option>
                            <option value="project_overview">Project Overview</option>
                        </select>
                    </div>

                    <div class="metric-selector">
                        <h6>Search Files</h6>
                        <input type="text" class="form-control mb-2" id="figma-search" placeholder="Search file names">
                        <button class="btn btn-outline-secondary w-100" onclick="searchFigmaFiles()">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>

                    <button class="btn btn-primary w-100" onclick="updateFigmaDashboard()">
                        <i class="fas fa-sync"></i> Update Figma Analytics
                    </button>
            </div>

                <!-- Datadog Configuration -->
                <div id="datadog-sidebar" style="display: none;">
                    <h5><i class="fas fa-chart-line"></i> Datadog Configuration</h5>
                    
                    <div class="datadog-info">
                        <small><strong>Datadog Integration:</strong> Logs, Metrics & Monitoring</small><br>
                        <small><strong>Site:</strong> <span id="datadog-site-info">datadoghq.com</span></small><br>
                        <small><strong>Status:</strong> <span id="datadog-status-info">Ready</span></small>
                </div>

                    <div class="metric-selector">
                        <h6><i class="fas fa-cog"></i> Log Configuration</h6>
                <div class="row">
                    <div class="col-12">
                                <label for="datadog-time-range" class="form-label">Time Range</label>
                                <select class="form-select" id="datadog-time-range">
                                    <option value="1">Last 1 hour</option>
                                    <option value="6">Last 6 hours</option>
                                    <option value="24" selected>Last 24 hours</option>
                                    <option value="72">Last 3 days</option>
                                    <option value="168">Last 7 days</option>
                                </select>
                    </div>
                </div>
                    </div>

                    <div class="metric-selector">
                        <h6>Service Filter</h6>
                        <select class="form-select" id="datadog-service-filter">
                                                    <option value="">All Services</option>
                            <option value="ultrataxapiservices">UltraTax API Services</option>
                            <option value="ultrataxclientservices">UltraTax Client Services</option>
                            <option value="taxassistantservices">Tax Assistant Services</option>
                                                </select>
                                            </div>

                    <div class="metric-selector">
                        <h6>Log Level Filter</h6>
                        <select class="form-select" id="datadog-level-filter">
                                                    <option value="">All Levels</option>
                            <option value="ERROR">ERROR</option>
                            <option value="WARN">WARN</option>
                            <option value="INFO">INFO</option>
                            <option value="DEBUG">DEBUG</option>
                            <option value="TRACE">TRACE</option>
                                                </select>
                                            </div>

                    <div class="metric-selector">
                        <h6>Log Limit</h6>
                        <select class="form-select" id="datadog-limit-filter">
                            <option value="50">50 logs</option>
                            <option value="100" selected>100 logs</option>
                            <option value="500">500 logs</option>
                            <option value="1000">1000 logs</option>
                        </select>
                                            </div>

                    <button class="btn btn-primary w-100" onclick="searchDatadogLogs()">
                                                    <i class="fas fa-search"></i> Search Logs
                                                </button>
                            </div>
                        </div>

            <!-- Main Content -->
            <div class="col-md-9 main-content">
                <!-- Welcome Screen (shown when no data is loaded) -->
                <div id="welcomeScreen" class="text-center py-5">
                    <div class="welcome-hero">
                        <i class="fas fa-chart-line fa-4x mb-4" style="color: var(--tr-orange);"></i>
                        <h2 style="color: var(--tr-dark-blue); font-weight: 700;">Welcome to Thomson Reuters Analytics</h2>
                        <p class="lead text-muted mb-5">Your enterprise analytics platform for Azure DevOps, GitHub, Datadog, and Figma</p>
                        
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="card welcome-setup-card">
                                    <div class="card-body p-4">
                                        <h4 class="mb-4" style="color: var(--tr-dark-blue);">
                                            <i class="fas fa-rocket"></i> Get Started in 3 Easy Steps
                                        </h4>
                                        
                                        <div class="setup-steps">
                                            <div class="setup-step">
                                                <div class="step-number">1</div>
                                                <div class="step-content">
                                                    <h6>Configure Your Project</h6>
                                                    <p class="text-muted">Set up your Azure DevOps organization, project, and area path</p>
                                                    <button class="btn btn-primary btn-sm" onclick="showWelcomeModal()">
                                                        <i class="fas fa-cog"></i> Start Setup
                                                </button>
                                            </div>
                                                </div>
                                            
                                            <div class="setup-step">
                                                <div class="step-number">2</div>
                                                <div class="step-content">
                                                    <h6>Verify Your Token</h6>
                                                    <p class="text-muted">Ensure your Azure DevOps PAT token has proper permissions</p>
                                                    <small class="text-info">
                                                        <i class="fas fa-info-circle"></i> Required: Work Items (Read) & Code (Read)
                                                    </small>
                                            </div>
                                        </div>
                                            
                                            <div class="setup-step">
                                                <div class="step-number">3</div>
                                                <div class="step-content">
                                                    <h6>Start Analyzing</h6>
                                                    <p class="text-muted">View your development metrics and insights</p>
                                                    <small class="text-success">
                                                        <i class="fas fa-check-circle"></i> Analytics will load automatically
                                                    </small>
                                </div>
                            </div>
                        </div>

                                        <div class="mt-4 p-3" style="background: linear-gradient(135deg, #FFF4E6 0%, #FFF8F0 100%); border-radius: 8px; border-left: 4px solid var(--tr-orange);">
                                            <h6 style="color: var(--tr-dark-blue); margin-bottom: 8px;">
                                                <i class="fas fa-lightbulb"></i> Quick Tip
                                            </h6>
                                            <p class="mb-0 small text-muted">
                                                Once configured, you'll have access to work item analytics, pull request insights, 
                                                repository metrics, and comprehensive development dashboards.
                                            </p>
                                    </div>
                                    </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                <!-- Analytics Content (hidden initially) -->
                <div id="analyticsContent" style="display: none;">
                <div class="row mb-4">
                            <div class="col-12">
                        <h2><i class="fas fa-tachometer-alt"></i> Analytics Overview</h2>
                        <p class="text-muted">GitHub Pull Requests, Azure DevOps & Figma Analytics</p>
                        </div>
                    </div>

                <!-- Navigation Tabs -->
                <ul class="nav nav-tabs mb-4" id="analyticsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="azuredevops-tab" data-bs-toggle="tab" data-bs-target="#azuredevops-pane" type="button" role="tab">
                            <i class="fab fa-microsoft"></i> Azure DevOps
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="github-tab" data-bs-toggle="tab" data-bs-target="#github-pane" type="button" role="tab">
                            <i class="fab fa-github"></i> GitHub Pull Requests
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="datadog-logs-tab" data-bs-toggle="tab" data-bs-target="#datadog-pane" type="button" role="tab">
                            <i class="fas fa-file-alt"></i> Datadog Logs
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="figma-tab" data-bs-toggle="tab" data-bs-target="#figma-pane" type="button" role="tab">
                            <i class="fab fa-figma"></i> Figma
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="analyticsTabContent">





                    <!-- GitHub Tab -->
                    <div class="tab-pane fade" id="github-pane" role="tabpanel">

                        <!-- GitHub Analytics Summary -->
                        <div class="row mb-4" id="github-summary">
                            <!-- Dynamic content will be loaded here -->
                        </div>

                        <!-- GitHub Charts -->
                        <div class="row">
                            <div class="col-12">
                                <h4><i class="fas fa-chart-area"></i> GitHub Pull Request Analytics</h4>
                            </div>
                        </div>

                        <div id="github-charts-container">
                            <!-- Dynamic charts will be loaded here -->
                        </div>

                        <!-- Recent Pull Requests -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4><i class="fas fa-list"></i> Recent Pull Requests</h4>
                                <div id="recent-prs-container">
                                    <!-- Dynamic content will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Azure DevOps Tab -->
                    <div class="tab-pane fade show active" id="azuredevops-pane" role="tabpanel">

                        <!-- Azure DevOps Analytics Summary -->
                        <div class="row mb-4" id="azuredevops-summary">
                            <!-- Dynamic content will be loaded here -->
                        </div>

                        <!-- Azure DevOps Charts -->
                        <div class="row">
                            <div class="col-12">
                                <h4><i class="fas fa-chart-area"></i> Work Item Analytics</h4>
                            </div>
                        </div>

                        <div id="azuredevops-charts-container">
                            <!-- Dynamic charts will be loaded here -->
                        </div>

                        <!-- Recent Work Items -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h4><i class="fas fa-tasks"></i> Recent Work Items</h4>
                                <div id="recent-workitems-container">
                                    <!-- Dynamic content will be loaded here -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h4><i class="fas fa-code-branch"></i> Recent Pull Requests</h4>
                                <div id="recent-azuredevops-prs-container">
                                    <!-- Dynamic content will be loaded here -->
                                </div>
                            </div>
                        </div>


                    </div>

                    <!-- Figma Tab -->
                    <div class="tab-pane fade" id="figma-pane" role="tabpanel">

                        <!-- Figma Analytics Summary -->
                        <div class="row mb-4" id="figma-summary">
                            <!-- Dynamic content will be loaded here -->
                        </div>

                        <!-- Figma Charts -->
                        <div class="row">
                            <div class="col-12">
                                <h4><i class="fas fa-chart-area"></i> Figma Analytics</h4>
                            </div>
                        </div>

                        <div id="figma-charts-container">
                            <!-- Dynamic charts will be loaded here -->
                        </div>

                        <!-- Recent Files and Projects -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h4><i class="fas fa-folder"></i> Recent Files</h4>
                                <div id="recent-figma-files-container">
                                    <!-- Dynamic content will be loaded here -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h4><i class="fas fa-users"></i> Active Collaborators</h4>
                                <div id="figma-collaborators-container">
                                    <!-- Dynamic content will be loaded here -->
                                </div>
                            </div>
                        </div>

                        <!-- Search Results -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4><i class="fas fa-search"></i> Search Results</h4>
                                <div id="figma-search-results-container">
                                    <!-- Dynamic content will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Datadog Logs Tab -->
                    <div class="tab-pane fade" id="datadog-pane" role="tabpanel">

                        <!-- Datadog Configuration Info -->
                        <div class="datadog-info">
                            <h5><i class="fas fa-cog fa-spin"></i> Datadog Configuration</h5>
                            <p><strong><i class="fas fa-globe"></i> Site:</strong> <span id="datadog-site">datadoghq.com</span></p>
                            <p><strong><i class="fas fa-check-circle"></i> Status:</strong> <span id="datadog-status">Ready</span></p>
    </div>

                        <!-- Log Search Controls -->
                        <div class="datadog-search-container">
                            <h5><i class="fas fa-search"></i> Log Search</h5>
            <div class="row">
                                <div class="col-md-10">
                                    <label for="datadog-query" class="form-label">Search Query</label>
                                    <input type="text" class="form-control" id="datadog-query" placeholder="Enter your search query (e.g., * for all logs, error, warning, etc.)" value="*">
                                    <small class="form-text text-muted">Use the sidebar configuration to set filters for service, level, time range, and limit.</small>
                        </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" onclick="searchDatadogLogs()">
                                        <i class="fas fa-search"></i> Search Logs
                                </button>
                            </div>
                            </div>
                            
                            <!-- Hidden filter elements for JavaScript functionality -->
                            <div style="display: none;">
                                <select id="datadog-service">
                                    <option value="">All Services</option>
                                    <!-- Services will be populated dynamically -->
                                </select>
                                <select id="datadog-level">
                                    <option value="">All Levels</option>
                                    <option value="ERROR">ERROR</option>
                                    <option value="WARN">WARN</option>
                                    <option value="INFO">INFO</option>
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="TRACE">TRACE</option>
                                </select>
                                <select id="datadog-hours">
                                    <option value="1">1 hour</option>
                                    <option value="6">6 hours</option>
                                    <option value="24" selected>24 hours</option>
                                    <option value="72">3 days</option>
                                    <option value="168">7 days</option>
                                </select>
                                <select id="datadog-limit">
                                    <option value="50">50</option>
                                    <option value="100" selected>100</option>
                                    <option value="500">500</option>
                                    <option value="1000">1000</option>
                                </select>
                    </div>
                </div>

                        <!-- Log Statistics -->
                        <div class="datadog-stats-container">
                            <h4><i class="fas fa-chart-bar"></i> Log Statistics</h4>
                            <div id="datadog-stats-container">
                                <!-- Dynamic statistics will be loaded here -->
                        </div>
                            </div>

                        <!-- Logs Results -->
                        <div class="datadog-logs-container">
                            <h4><i class="fas fa-list"></i> Log Entries</h4>
                            <div id="datadog-logs-container">
                                <div class="text-center" style="padding: 40px; color: #666;">
                                    <div style="background: #ff9800; width: 70px; height: 70px; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);">
                                        <i class="fas fa-search fa-2x" style="color: white;"></i>
                                    </div>
                                    <h5 style="color: #333; margin-bottom: 10px; font-weight: 600;">Ready to Search</h5>
                                    <p>Click the search button to fetch logs from Datadog</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedMetrics = [];
        let currentTimeRange = 24;
        let currentChartType = 'line';
        
        // Azure DevOps Cache for fast repository sync
        let azureDevOpsCache = {
            data: null,
            timestamp: null,
            isValid: function() {
                // Cache is valid for 5 minutes
                return this.data && this.timestamp && (Date.now() - this.timestamp) < 300000;
            },
            set: function(data) {
                this.data = data;
                this.timestamp = Date.now();
                console.log('üóÑÔ∏è Azure DevOps data cached for fast sync');
                // Update sync button status when cache is updated
                setTimeout(() => updateSyncButtonStatus(), 100);
            },
            get: function() {
                if (this.isValid()) {
                    console.log('‚úÖ Using cached Azure DevOps data');
                    return this.data;
                }
                console.log('‚ùå Cache expired or empty');
                return null;
            },
            clear: function() {
                this.data = null;
                this.timestamp = null;
                console.log('üóëÔ∏è Azure DevOps cache cleared');
            }
        };

        // Welcome Modal Functions
        function showWelcomeModal() {
            // Load default project settings before showing modal
            loadDefaultProjectSettings();
            
            // Ensure Bootstrap is loaded before trying to show modal
            if (typeof bootstrap !== 'undefined') {
                const welcomeModal = new bootstrap.Modal(document.getElementById('welcomeModal'));
                welcomeModal.show();
            } else {
                console.error('Bootstrap not loaded yet, retrying...');
                setTimeout(() => {
                    showWelcomeModal();
                }, 100);
            }
        }

        function skipSetup() {
            const welcomeModal = bootstrap.Modal.getInstance(document.getElementById('welcomeModal'));
            if (welcomeModal) {
                welcomeModal.hide();
            }
            
            // Show a brief toast notification
            showToast('Setup skipped. You can configure project settings anytime from the Azure DevOps tab.', 'info');
        }
        
        // Debug function to test modal
        function testModal() {
            console.log('üß™ Testing modal...');
            console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
            console.log('Modal element exists:', !!document.getElementById('welcomeModal'));
            console.log('Button element exists:', !!document.querySelector('[onclick="showWelcomeModal()"]'));
            showWelcomeModal();
        }

        function saveProjectSetup() {
            // Get form values
            const orgName = document.getElementById('setupOrgName').value.trim();
            const projectName = document.getElementById('setupProjectName').value.trim();
            const areaPath = document.getElementById('setupAreaPath').value.trim();
            const timeRange = document.getElementById('setupTimeRange').value;
            
            // Validate required fields
            if (!orgName || !projectName) {
                showToast('Please fill in both Organization Name and Project Name.', 'error');
                return;
            }
            
            // Save to the Azure DevOps configuration
            document.getElementById('azuredevops-org').value = orgName;
            document.getElementById('azuredevops-project').value = projectName;
            document.getElementById('azuredevops-area-path').value = areaPath;
            document.getElementById('azuredevops-time-range').value = timeRange;
            
            // Update global variables
            azuredevopsOrg = orgName;
            azuredevopsProject = projectName;
            azuredevopsAreaPath = areaPath;
            
            // Close modal
            const welcomeModal = bootstrap.Modal.getInstance(document.getElementById('welcomeModal'));
            welcomeModal.hide();
            
            // Switch to Azure DevOps tab
            const azuredevopsTab = document.getElementById('azuredevops-tab');
            if (azuredevopsTab) {
                azuredevopsTab.click();
            }
            
            // Mark project as configured and show analytics content with all tabs
            markProjectAsConfigured();
            
            // Show success message and highlight sidebar
            setTimeout(() => {
                showToast(`üéâ Project setup complete! Loading all analytics for ${orgName}/${projectName}`, 'success');
                
                // Highlight the Azure DevOps sidebar after it becomes visible
                setTimeout(() => {
                    const azuredevopsSidebar = document.getElementById('azuredevops-sidebar');
                    if (azuredevopsSidebar) {
                        azuredevopsSidebar.style.border = '2px solid var(--tr-orange)';
                        azuredevopsSidebar.style.borderRadius = '10px';
                        azuredevopsSidebar.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Remove highlight after 5 seconds
                        setTimeout(() => {
                            azuredevopsSidebar.style.border = '';
                        }, 5000);
                    }
                }, 1000);
            }, 500);
        }

        function loadDefaultProjectSettings() {
            // Pre-populate with existing values if available
            const existingOrg = document.getElementById('azuredevops-org')?.value || 'tr-tax';
            const existingProject = document.getElementById('azuredevops-project')?.value || 'TaxProf';
            const existingAreaPath = document.getElementById('azuredevops-area-path')?.value || 'TaxProf\\us\\taxAuto\\ADGE\\Prep';
            
            document.getElementById('setupOrgName').value = existingOrg;
            document.getElementById('setupProjectName').value = existingProject;
            document.getElementById('setupAreaPath').value = existingAreaPath;
        }

        function showToast(message, type = 'info') {
            // Create toast element if it doesn't exist
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '1055';
                document.body.appendChild(toastContainer);
            }
            
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="fas fa-info-circle text-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} me-2"></i>
                        <strong class="me-auto">Analytics Dashboard</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        // Check if this is the first visit and show appropriate screen
        function checkFirstVisit() {
            const hasVisited = localStorage.getItem('analytics-dashboard-visited');
            const hasConfiguredProject = localStorage.getItem('analytics-project-configured');
            
            if (!hasVisited) {
                localStorage.setItem('analytics-dashboard-visited', 'true');
                setTimeout(() => {
                    showWelcomeModal();
                }, 1000); // Show modal after 1 second to let page load
            } else if (!hasConfiguredProject) {
                // Show welcome screen instead of tabs if no project is configured
                showWelcomeScreen();
            } else {
                // Show analytics content if project is configured
                showAnalyticsContent();
            }
        }
        
        function showWelcomeScreen() {
            document.getElementById('welcomeScreen').style.display = 'block';
            document.getElementById('analyticsContent').style.display = 'none';
            
            // Hide sidebar during welcome screen
            const sidebar = document.querySelector('.col-md-3');
            const mainContent = document.querySelector('.col-md-9');
            if (sidebar && mainContent) {
                sidebar.style.display = 'none';
                mainContent.classList.remove('col-md-9');
                mainContent.classList.add('col-md-12');
            }
            
            console.log('üìã Showing welcome screen - no project configured');
        }
        
        function showAnalyticsContent() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('analyticsContent').style.display = 'block';
            
            // Show sidebar when analytics content is displayed
            const sidebar = document.querySelector('.col-md-3');
            const mainContent = document.querySelector('.col-md-12');
            if (sidebar && mainContent) {
                sidebar.style.display = 'block';
                mainContent.classList.remove('col-md-12');
                mainContent.classList.add('col-md-9');
            }
            
            // Initialize all tabs and load their data
            initializeAllTabs();
            
            console.log('üìä Showing analytics content - project configured');
        }
        
        function initializeAllTabs() {
            console.log('üöÄ Initializing all tabs and loading data...');
            
            // Load Azure DevOps data (primary tab)
            setTimeout(() => {
                if (typeof configureAzureDevOps === 'function') {
                    configureAzureDevOps();
                }
            }, 100);
            
            // Load GitHub data
            setTimeout(() => {
                if (typeof updateGitHubSummary === 'function') {
                    updateGitHubSummary();
                }
            }, 500);
            
            // Load Datadog dashboards
            setTimeout(() => {
                if (typeof loadAllDashboards === 'function') {
                    loadAllDashboards();
                }
            }, 1000);
            
            // Load Datadog metrics
            setTimeout(() => {
                if (typeof loadAvailableMetrics === 'function') {
                    loadAvailableMetrics();
                }
            }, 1500);
            
            // Load Datadog logs
            setTimeout(() => {
                if (typeof loadLogsSummary === 'function') {
                    loadLogsSummary();
                }
                if (typeof loadAvailableServices === 'function') {
                    loadAvailableServices();
                }
            }, 2000);
            
            // Load Figma data
            setTimeout(() => {
                if (typeof updateFigmaAnalytics === 'function') {
                    updateFigmaAnalytics();
                }
            }, 2500);
            
            console.log('‚úÖ All tabs initialization scheduled');
        }
        
        function markProjectAsConfigured() {
            localStorage.setItem('analytics-project-configured', 'true');
            showAnalyticsContent();
        }
        
        // For testing - reset project configuration
        function resetProjectConfiguration() {
            localStorage.removeItem('analytics-project-configured');
            showWelcomeScreen();
            console.log('üîÑ Project configuration reset - showing welcome screen');
        }

        // Load available metrics on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check for first visit and show welcome modal
            checkFirstVisit();
            
            loadAvailableMetrics();
            
            // Update sync button status on page load
            setTimeout(() => updateSyncButtonStatus(), 500);
            
            // Auto-select some default metrics for better user experience
            setTimeout(() => {
                const defaultMetrics = ['cpu', 'memory', 'disk'];
                defaultMetrics.forEach(metricId => {
                    const checkbox = document.getElementById(metricId);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                
                // Update dashboard with default metrics
                updateDashboard();
            }, 500);
            
            // Handle tab switching
            const datadogLogsTab = document.getElementById('datadog-logs-tab');
            const githubTab = document.getElementById('github-tab');
            const azuredevopsTab = document.getElementById('azuredevops-tab');
            const figmaTab = document.getElementById('figma-tab');
            const datadogSidebar = document.getElementById('datadog-sidebar');
            const githubSidebar = document.getElementById('github-sidebar');
            const azuredevopsSidebar = document.getElementById('azuredevops-sidebar');
            const figmaSidebar = document.getElementById('figma-sidebar');
            
            datadogLogsTab.addEventListener('click', function() {
                datadogSidebar.style.display = 'block';
                githubSidebar.style.display = 'none';
                azuredevopsSidebar.style.display = 'none';
                figmaSidebar.style.display = 'none';
            });
            
            githubTab.addEventListener('click', function() {
                datadogSidebar.style.display = 'none';
                githubSidebar.style.display = 'block';
                azuredevopsSidebar.style.display = 'none';
                figmaSidebar.style.display = 'none';
                
                // Load GitHub data when tab is first clicked
                if (githubConfigured && selectedRepos.length > 0) {
                    updateGitHubDashboard();
                }
            });
            
            azuredevopsTab.addEventListener('click', function() {
                datadogSidebar.style.display = 'none';
                githubSidebar.style.display = 'none';
                azuredevopsSidebar.style.display = 'block';  // Show Azure DevOps sidebar
                figmaSidebar.style.display = 'none';
            });
            
            figmaTab.addEventListener('click', function() {
                datadogSidebar.style.display = 'none';
                githubSidebar.style.display = 'none';
                azuredevopsSidebar.style.display = 'none';
                figmaSidebar.style.display = 'block';
            });
            
            // Show Azure DevOps sidebar by default since it's the active tab
            azuredevopsSidebar.style.display = 'block';
            datadogSidebar.style.display = 'none';
            githubSidebar.style.display = 'none';
            figmaSidebar.style.display = 'none';
            
            // Sync sidebar controls with main Datadog section
            const sidebarTimeRange = document.getElementById('datadog-time-range');
            const sidebarServiceFilter = document.getElementById('datadog-service-filter');
            const sidebarLevelFilter = document.getElementById('datadog-level-filter');
            const sidebarLimitFilter = document.getElementById('datadog-limit-filter');
            
            const mainTimeRange = document.getElementById('datadog-hours');
            const mainServiceFilter = document.getElementById('datadog-service');
            const mainLevelFilter = document.getElementById('datadog-level');
            const mainLimitFilter = document.getElementById('datadog-limit');
            
            // Sync sidebar to main when sidebar changes
            if (sidebarTimeRange && mainTimeRange) {
                sidebarTimeRange.addEventListener('change', function() {
                    mainTimeRange.value = this.value;
                });
            }
            
            if (sidebarServiceFilter && mainServiceFilter) {
                sidebarServiceFilter.addEventListener('change', function() {
                    mainServiceFilter.value = this.value;
                });
            }
            
            if (sidebarLevelFilter && mainLevelFilter) {
                sidebarLevelFilter.addEventListener('change', function() {
                    mainLevelFilter.value = this.value;
                });
            }
            
            if (sidebarLimitFilter && mainLimitFilter) {
                sidebarLimitFilter.addEventListener('change', function() {
                    mainLimitFilter.value = this.value;
                });
            }
            
            // Sync main to sidebar when main changes
            if (mainTimeRange && sidebarTimeRange) {
                mainTimeRange.addEventListener('change', function() {
                    sidebarTimeRange.value = this.value;
                });
            }
            
            if (mainServiceFilter && sidebarServiceFilter) {
                mainServiceFilter.addEventListener('change', function() {
                    sidebarServiceFilter.value = this.value;
                });
            }
            
            if (mainLevelFilter && sidebarLevelFilter) {
                mainLevelFilter.addEventListener('change', function() {
                    sidebarLevelFilter.value = this.value;
                });
            }
            
            if (mainLimitFilter && sidebarLimitFilter) {
                mainLimitFilter.addEventListener('change', function() {
                    sidebarLimitFilter.value = this.value;
                });
            }
        });

        async function loadAvailableMetrics() {
            try {
                const response = await fetch('/api/metrics');
                const metrics = await response.json();
                
                const metricsList = document.getElementById('metrics-list');
                
                // Add any new metrics that aren't already in the list
                const existingMetrics = Array.from(metricsList.querySelectorAll('input[type="checkbox"]')).map(cb => cb.value);
                
                metrics.forEach(metric => {
                    if (!existingMetrics.includes(metric)) {
                        const div = document.createElement('div');
                        div.className = 'form-check';
                        div.innerHTML = `
                            <input class="form-check-input" type="checkbox" value="${metric}" id="${metric.replace(/[^a-zA-Z0-9]/g, '_')}">
                            <label class="form-check-label" for="${metric.replace(/[^a-zA-Z0-9]/g, '_')}">
                                ${metric}
                            </label>
                        `;
                        metricsList.appendChild(div);
                    }
                });
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        function addCustomMetric() {
            const customMetricInput = document.getElementById('custom-metric');
            const metricName = customMetricInput.value.trim();
            
            if (!metricName) {
                alert('Please enter a metric name');
                return;
            }
            
            // Check if metric already exists
            const existingCheckbox = document.querySelector(`input[value="${metricName}"]`);
            if (existingCheckbox) {
                alert('Metric already exists in the list');
                return;
            }
            
            // Add the custom metric
            const metricsList = document.getElementById('metrics-list');
            const div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = `
                <input class="form-check-input" type="checkbox" value="${metricName}" id="${metricName.replace(/[^a-zA-Z0-9]/g, '_')}" checked>
                <label class="form-check-label" for="${metricName.replace(/[^a-zA-Z0-9]/g, '_')}">
                    ${metricName}
                </label>
            `;
            metricsList.appendChild(div);
            
            // Clear the input
            customMetricInput.value = '';
            
            // Update dashboard with new metric
            updateDashboard();
        }

        function getSelectedMetrics() {
            const checkboxes = document.querySelectorAll('#metrics-list input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        async function updateDashboard() {
            selectedMetrics = getSelectedMetrics();
            currentTimeRange = document.getElementById('time-range').value;
            currentChartType = document.getElementById('chart-type').value;

            if (selectedMetrics.length === 0) {
                // Show a friendly message instead of an alert
                const container = document.getElementById('metrics-summary');
                container.innerHTML = '<div class="col-12"><div class="alert alert-info"><i class="fas fa-info-circle"></i> Please select one or more metrics from the sidebar to view analytics.</div></div>';
                
                const chartsContainer = document.getElementById('charts-container');
                chartsContainer.innerHTML = '<div class="col-12"><div class="alert alert-info"><i class="fas fa-chart-line"></i> Select metrics to display charts and analytics.</div></div>';
                return;
            }

            // Update metrics summary
            await updateMetricsSummary();
            
            // Update charts
            await updateCharts();
        }

        async function updateMetricsSummary() {
            try {
                const params = new URLSearchParams();
                selectedMetrics.forEach(metric => params.append('metrics', metric));
                params.append('hours', currentTimeRange);

                const response = await fetch(`/api/analytics?${params}`);
                const result = await response.json();

                if (result.status === 'success') {
                    displayMetricsSummary(result.data);
                } else {
                    console.error('Error updating metrics summary:', result.message);
                    displayError('Failed to load metrics summary: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating metrics summary:', error);
                displayError('Error connecting to Datadog API');
            }
        }

        function displayMetricsSummary(data) {
            const container = document.getElementById('metrics-summary');
            container.innerHTML = '';

            if (data.metrics_summary && data.metrics_summary.length > 0) {
                data.metrics_summary.forEach(metric => {
                    const col = document.createElement('div');
                    col.className = 'col-md-3 mb-3';
                    col.innerHTML = `
                        <div class="card metric-card h-100">
                            <div class="card-body">
                                <h6 class="card-title">${metric.metric_name}</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Avg</small>
                                        <div class="fw-bold">${metric.avg_value.toFixed(2)}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Max</small>
                                        <div class="fw-bold">${metric.max_value.toFixed(2)}</div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">Data Points: ${metric.data_points}</small>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                });
            } else {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">No metrics data available for the selected time range.</div></div>';
            }
        }

        function displayError(message) {
            const container = document.getElementById('metrics-summary');
            container.innerHTML = `<div class="col-12"><div class="alert alert-danger">${message}</div></div>`;
        }

        async function updateCharts() {
            const container = document.getElementById('charts-container');
            container.innerHTML = '';

            for (const metric of selectedMetrics) {
                try {
                    const response = await fetch(`/api/charts/${metric}?hours=${currentTimeRange}&type=${currentChartType}`);
                    const result = await response.json();

                    if (result.status === 'success') {
                        const chartDiv = document.createElement('div');
                        chartDiv.className = 'col-md-6 mb-4';
                        chartDiv.innerHTML = `
                            <div class="chart-container">
                                <h5>${metric}</h5>
                                <div id="chart-${metric.replace(/[^a-zA-Z0-9]/g, '_')}" style="height: 400px;"></div>
                            </div>
                        `;
                        container.appendChild(chartDiv);

                        // Render the chart
                        const chartData = JSON.parse(result.chart);
                        Plotly.newPlot(`chart-${metric.replace(/[^a-zA-Z0-9]/g, '_')}`, chartData.data, chartData.layout);
                    } else {
                        console.error(`Error loading chart for ${metric}:`, result.message);
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'col-md-6 mb-4';
                        errorDiv.innerHTML = `
                            <div class="chart-container">
                                <h5>${metric}</h5>
                                <div class="alert alert-warning">No data available for this metric</div>
                            </div>
                        `;
                        container.appendChild(errorDiv);
                    }
                } catch (error) {
                    console.error(`Error loading chart for ${metric}:`, error);
                }
            }
        }

        // Auto-refresh every 5 minutes
        setInterval(updateDashboard, 300000);

        // GitHub Analytics Functions
        let githubConfigured = false;
        let selectedRepos = []; // Array to store multiple repositories

        function addGitHubRepo() {
            const repoInput = document.getElementById('github-repo-input');
            const repoPath = repoInput.value.trim();
            
            if (!repoPath) {
                alert('Please enter a repository path');
                return;
            }
            
            // Validate format (owner/repo)
            const parts = repoPath.split('/');
            if (parts.length !== 2 || !parts[0] || !parts[1]) {
                alert('Please enter repository in format: owner/repo (e.g., microsoft/vscode)');
                return;
            }
            
            // Check if repository already exists
            if (selectedRepos.includes(repoPath)) {
                alert('Repository already added');
                return;
            }
            
            selectedRepos.push(repoPath);
            repoInput.value = '';
            updateReposList();
            updateGitHubRepoInfo();
        }
        
        function removeRepo(repoPath) {
            const index = selectedRepos.indexOf(repoPath);
            if (index > -1) {
                selectedRepos.splice(index, 1);
                updateReposList();
                updateGitHubRepoInfo();
            }
        }
        
        function clearAllRepos() {
            selectedRepos = [];
            updateReposList();
            updateGitHubRepoInfo();
        }
        
        function updateReposList() {
            const container = document.getElementById('selected-repos');
            
            if (selectedRepos.length === 0) {
                container.innerHTML = '<small class="text-muted">No repositories selected</small>';
                githubConfigured = false;
                return;
            }
            
            githubConfigured = true;
            
            let html = '';
            selectedRepos.forEach(repo => {
                html += `
                    <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded">
                        <small><strong>${repo}</strong></small>
                        <button class="btn btn-outline-danger btn-sm" onclick="removeRepo('${repo}')" title="Remove repository">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        function updateGitHubRepoInfo() {
            const infoElement = document.getElementById('github-repo-info');
            if (selectedRepos.length === 0) {
                infoElement.textContent = 'None configured';
            } else if (selectedRepos.length === 1) {
                infoElement.textContent = selectedRepos[0];
            } else {
                infoElement.textContent = `${selectedRepos.length} repositories`;
            }
        }

        async function syncRepositoriesFromAzureDevOps() {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            
            try {
                // Show loading state
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
                button.disabled = true;
                
                // First, try to use cached data from Azure DevOps tab
                const cachedData = azureDevOpsCache.get();
                let result = null;
                
                if (cachedData && cachedData.resolved_repositories) {
                    console.log('üöÄ Using cached Azure DevOps data for fast sync');
                    // Use cached data - format it like the API response
                    result = {
                        status: 'success',
                        repositories: cachedData.resolved_repositories,
                        total_repositories: cachedData.resolved_repositories.length,
                        source: 'cache',
                        note: 'Data loaded from Azure DevOps tab cache'
                    };
                } else {
                    console.log('‚è≥ No cache available, fetching from API...');
                    // Fallback to API call if no cache available
                    const org = document.getElementById('azuredevops-org').value;
                    const project = document.getElementById('azuredevops-project').value;
                    const areaPath = document.getElementById('azuredevops-area-path').value;
                    const days = document.getElementById('github-time-range').value || 30;
                    
                    if (!org || !project) {
                        alert('Please configure Azure DevOps organization and project first in the Azure DevOps tab, or load data in the Azure DevOps tab first.');
                        return;
                    }
                    
                    // Build API URL
                    const params = new URLSearchParams({
                        days: days,
                        org: org,
                        project: project
                    });
                    
                    if (areaPath) {
                        params.append('area_path', areaPath);
                    }
                    
                    // Fetch repositories from Azure DevOps
                    const response = await fetch(`/api/azuredevops/repositories?${params}`);
                    result = await response.json();
                }
                
                if (result.status === 'success' && result.repositories.length > 0) {
                    // Clear existing repositories
                    selectedRepos.length = 0;
                    
                    // Add repositories from Azure DevOps
                    let addedCount = 0;
                    let resolvedCount = 0;
                    result.repositories.forEach(repo => {
                        // Use the actual resolved GitHub repository name
                        const repoFormat = repo.github_repo;
                        if (!selectedRepos.includes(repoFormat)) {
                            selectedRepos.push(repoFormat);
                            addedCount++;
                            if (repo.resolved) {
                                resolvedCount++;
                            }
                        }
                    });
                    
                    // Update UI
                    updateReposList();
                    updateGitHubRepoInfo();
                    
                    // Show success message
                    button.innerHTML = '<i class="fas fa-check text-success"></i> Synced!';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);
                    
                    // Show info about what was synced
                    const resolvedMessage = resolvedCount > 0 ? 
                        `‚úÖ ${resolvedCount} repositories resolved to actual GitHub names\n` : '';
                    const unresolvedMessage = (addedCount - resolvedCount) > 0 ? 
                        `‚ö†Ô∏è ${addedCount - resolvedCount} repositories could not be resolved (using fallback names)\n` : '';
                    const sourceMessage = result.source === 'cache' ? 
                        `‚ö° Data loaded instantly from Azure DevOps tab cache\n` : 
                        `üîÑ Data fetched from Azure DevOps API\n`;
                    
                    alert(`üîó Successfully synced ${addedCount} repositories from Azure DevOps!\n\n${sourceMessage}${resolvedMessage}${unresolvedMessage}\nRepositories added:\n${selectedRepos.join('\n')}`);
                    
                } else if (result.repositories && result.repositories.length === 0) {
                    alert('No GitHub repositories found in Azure DevOps work items for the selected time range and area path.');
                } else {
                    alert(`Failed to sync repositories: ${result.message || 'Unknown error'}`);
                }
                
            } catch (error) {
                console.error('Error syncing repositories:', error);
                alert(`Error syncing repositories: ${error.message}`);
            } finally {
                // Reset button state if not already done
                if (button.disabled) {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }
        }

        async function updateGitHubDashboard() {
            if (!githubConfigured || selectedRepos.length === 0) {
                document.getElementById('github-summary').innerHTML = '<div class="col-12"><div class="alert alert-info">Please add at least one GitHub repository first.</div></div>';
                return;
            }

            const days = document.getElementById('github-time-range').value;
            const chartType = document.getElementById('github-chart-type').value;
            const updateBtn = document.getElementById('github-update-btn');

            // Disable button and show loading state
            updateBtn.disabled = true;
            updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

            // Show loading states for all sections
            showGitHubLoadingStates();

            try {
                // Update GitHub analytics summary
                await updateGitHubSummary(days);
                
                // Update GitHub charts
                await updateGitHubCharts(days, chartType);
                
                // Update recent PRs
                await updateRecentPRs(days);
            } catch (error) {
                console.error('Error updating GitHub dashboard:', error);
                showGitHubErrorStates();
            } finally {
                // Re-enable button
                updateBtn.disabled = false;
                updateBtn.innerHTML = '<i class="fas fa-sync"></i> Update GitHub Analytics';
            }
        }

        function showGitHubLoadingStates() {
            // Show loading state for summary
            document.getElementById('github-summary').innerHTML = `
                <div class="col-12">
                    <div class="text-center" style="padding: 40px;">
                        <div style="background: #9c27b0; width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);">
                            <i class="fas fa-spinner fa-spin fa-2x" style="color: white;"></i>
                        </div>
                        <h5 style="color: #333; margin-bottom: 10px; font-weight: 600;">Loading GitHub Analytics...</h5>
                        <p style="color: #666;">Fetching pull request data from GitHub</p>
                    </div>
                </div>
            `;

            // Show loading state for charts
            document.getElementById('github-charts-container').innerHTML = `
                <div class="col-12">
                    <div class="text-center" style="padding: 40px;">
                        <div style="background: #9c27b0; width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);">
                            <i class="fas fa-chart-line fa-spin fa-2x" style="color: white;"></i>
                        </div>
                        <h5 style="color: #333; margin-bottom: 10px; font-weight: 600;">Loading Charts...</h5>
                        <p style="color: #666;">Generating analytics charts</p>
                    </div>
                </div>
            `;

            // Show loading state for recent PRs
            document.getElementById('recent-prs-container').innerHTML = `
                <div class="text-center" style="padding: 40px;">
                    <div style="background: #9c27b0; width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);">
                        <i class="fas fa-code-branch fa-spin fa-2x" style="color: white;"></i>
                    </div>
                    <h5 style="color: #333; margin-bottom: 10px; font-weight: 600;">Loading Recent PRs...</h5>
                    <p style="color: #666;">Fetching recent pull requests</p>
                </div>
            `;
        }

        function showGitHubErrorStates() {
            // Show error state for summary
            document.getElementById('github-summary').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger" style="background: #ffebee; border: 1px solid #f44336; color: #c62828; border-radius: 4px; padding: 15px;">
                        <i class="fas fa-exclamation-triangle fa-lg" style="color: #f44336;"></i>
                        <strong>Error loading GitHub analytics</strong>
                    </div>
                </div>
            `;

            // Show error state for charts
            document.getElementById('github-charts-container').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger" style="background: #ffebee; border: 1px solid #f44336; color: #c62828; border-radius: 4px; padding: 15px;">
                        <i class="fas fa-exclamation-triangle fa-lg" style="color: #f44336;"></i>
                        <strong>Error loading GitHub charts</strong>
                    </div>
                </div>
            `;

            // Show error state for recent PRs
            document.getElementById('recent-prs-container').innerHTML = `
                <div class="alert alert-danger" style="background: #ffebee; border: 1px solid #f44336; color: #c62828; border-radius: 4px; padding: 15px;">
                    <i class="fas fa-exclamation-triangle fa-lg" style="color: #f44336;"></i>
                    <strong>Error loading recent pull requests</strong>
                </div>
            `;
        }

        async function updateGitHubSummary(days) {
            try {
                // Send multiple repositories as URL parameters
                const repoParams = selectedRepos.map(repo => `repos=${encodeURIComponent(repo)}`).join('&');
                const response = await fetch(`/api/github/prs?days=${days}&${repoParams}`);
                const result = await response.json();

                if (result.status === 'success') {
                    displayGitHubSummary(result.data);
                } else {
                    console.error('Error updating GitHub summary:', result.message);
                    displayGitHubError('Failed to load GitHub analytics: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating GitHub summary:', error);
                displayGitHubError('Error connecting to GitHub API');
            }
        }

        function displayGitHubSummary(data) {
            const container = document.getElementById('github-summary');
            container.innerHTML = '';

            const summaryCards = [
                {
                    title: 'Total PRs',
                    value: data.total_prs,
                    icon: 'fas fa-code-branch',
                    color: 'primary'
                },
                {
                    title: 'Open PRs',
                    value: data.open_prs,
                    icon: 'fas fa-clock',
                    color: 'warning'
                },
                {
                    title: 'Merged PRs',
                    value: data.merged_prs,
                    icon: 'fas fa-check',
                    color: 'success'
                },
                {
                    title: 'Avg Commits',
                    value: data.average_commits.toFixed(1),
                    icon: 'fas fa-commit',
                    color: 'info'
                }
            ];

            summaryCards.forEach(card => {
                const col = document.createElement('div');
                col.className = 'col-md-3 mb-3';
                col.innerHTML = `
                    <div class="card metric-card h-100">
                        <div class="card-body text-center">
                            <i class="${card.icon} fa-2x text-${card.color} mb-2"></i>
                            <h5 class="card-title">${card.value}</h5>
                            <p class="card-text text-muted">${card.title}</p>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        function displayGitHubError(message) {
            const container = document.getElementById('github-summary');
            container.innerHTML = `<div class="col-12"><div class="alert alert-danger">${message}</div></div>`;
        }

        function displaySummaryTable(tableData) {
            const container = document.getElementById('github-summary-table');
            
            // Generate table HTML
            let tableHtml = '<div class="table-responsive"><table class="table table-striped table-hover">';
            
            // Add headers
            tableHtml += '<thead class="table-dark"><tr>';
            tableData.headers.forEach(header => {
                tableHtml += `<th>${header}</th>`;
            });
            tableHtml += '</tr></thead>';
            
            // Add rows
            tableHtml += '<tbody>';
            tableData.rows.forEach((row, index) => {
                const isLastRow = index === tableData.rows.length - 1;
                const rowClass = isLastRow ? 'table-warning' : '';
                
                tableHtml += `<tr class="${rowClass}">`;
                row.forEach(cell => {
                    tableHtml += `<td>${cell}</td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody>';
            
            tableHtml += '</table></div>';
            
            // Add some summary statistics cards
            const lastRow = tableData.rows[tableData.rows.length - 1];
            const totalPRs = parseInt(lastRow[1].replace(/<\/?strong>/g, ''));
            const totalMerged = parseInt(lastRow[4].replace(/<\/?strong>/g, ''));
            
            tableHtml += `
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h5>${tableData.rows.length - 1}</h5>
                                    <small>Repositories</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <h5>${totalPRs}</h5>
                                    <small>Total PRs</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h5>${totalMerged}</h5>
                                    <small>Merged PRs</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h5>${lastRow[5].replace(/<\/?strong>/g, '')}</h5>
                                    <small>Merge Rate</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }

        async function updateGitHubCharts(days, chartType) {
            const container = document.getElementById('github-charts-container');
            container.innerHTML = '';

            try {
                // Send multiple repositories as URL parameters
                const repoParams = selectedRepos.map(repo => `repos=${encodeURIComponent(repo)}`).join('&');
                const response = await fetch(`/api/github/prs/chart?days=${days}&type=${chartType}&${repoParams}`);
                const result = await response.json();

                if (result.status === 'success') {
                    const chartDiv = document.createElement('div');
                    chartDiv.className = 'col-12 mb-4';
                    
                    // Check if this is a table or a chart
                    if (result.chart_type === 'summary' && result.chart.type === 'table') {
                        // Display as table
                        chartDiv.innerHTML = `
                            <div class="chart-container">
                                <h5>Repository Summary</h5>
                                <div id="github-summary-table"></div>
                            </div>
                        `;
                        container.appendChild(chartDiv);
                        
                        // Generate the table HTML
                        displaySummaryTable(result.chart);
                        
                    } else {
                        // Display as chart
                    chartDiv.innerHTML = `
                        <div class="chart-container">
                            <div id="github-chart" style="height: 500px;"></div>
                        </div>
                    `;
                    container.appendChild(chartDiv);

                    // Render the chart
                    const chartData = JSON.parse(result.chart);
                    Plotly.newPlot('github-chart', chartData.data, chartData.layout);
                    }
                } else {
                    console.error('Error loading GitHub chart:', result.message);
                    container.innerHTML = '<div class="col-12"><div class="alert alert-warning">No data available for GitHub analytics</div></div>';
                }
            } catch (error) {
                console.error('Error loading GitHub chart:', error);
                container.innerHTML = '<div class="col-12"><div class="alert alert-danger">Error loading GitHub chart</div></div>';
            }
        }

        async function updateRecentPRs(days) {
            try {
                const response = await fetch(`/api/github/prs?days=${days}`);
                const result = await response.json();

                if (result.status === 'success' && result.data.recent_prs) {
                    displayRecentPRs(result.data.recent_prs);
                } else {
                    document.getElementById('recent-prs-container').innerHTML = '<div class="alert alert-info">No recent pull requests found.</div>';
                }
            } catch (error) {
                console.error('Error loading recent PRs:', error);
                document.getElementById('recent-prs-container').innerHTML = '<div class="alert alert-danger">Error loading recent pull requests</div>';
            }
        }

        function displayRecentPRs(prs) {
            const container = document.getElementById('recent-prs-container');
            container.innerHTML = '';

            prs.forEach(pr => {
                const prDiv = document.createElement('div');
                prDiv.className = 'card mb-3';
                
                const stateClass = pr.state === 'open' ? 'success' : pr.merged_at ? 'primary' : 'secondary';
                const stateIcon = pr.state === 'open' ? 'fas fa-clock' : pr.merged_at ? 'fas fa-check' : 'fas fa-times';
                
                prDiv.innerHTML = `
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="card-title">
                                    <a href="${pr.html_url}" target="_blank" class="text-decoration-none">
                                        #${pr.number} ${pr.title}
                                    </a>
                                </h6>
                                <p class="card-text text-muted">${pr.body ? pr.body.substring(0, 100) + '...' : 'No description'}</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-${stateClass} mb-2">
                                    <i class="${stateIcon}"></i> ${pr.state}
                                </span>
                                <div class="text-muted">
                                    <small>By ${pr.user.login}</small><br>
                                    <small>${new Date(pr.created_at).toLocaleDateString()}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(prDiv);
            });
        }

        // Azure DevOps Analytics Functions
        let azuredevopsConfigured = false;
        let azuredevopsOrg = '';
        let azuredevopsProject = '';
        let azuredevopsAreaPath = '';

        function configureAzureDevOps() {
            const org = document.getElementById('azuredevops-org').value.trim();
            const project = document.getElementById('azuredevops-project').value.trim();
            const areaPath = document.getElementById('azuredevops-area-path').value.trim();
            
            if (!org || !project) {
                alert('Please enter both organization and project name');
                return;
            }
            
            azuredevopsOrg = org;
            azuredevopsProject = project;
            azuredevopsAreaPath = areaPath;
            azuredevopsConfigured = true;
            
            document.getElementById('azuredevops-project-info').textContent = `${org}/${project}`;
            document.getElementById('azuredevops-area-info').textContent = areaPath || 'Project root';
            
            // Update Azure DevOps dashboard
            updateAzureDevOpsDashboard();
        }

        async function updateAzureDevOpsDashboard() {
            if (!azuredevopsConfigured) {
                document.getElementById('azuredevops-summary').innerHTML = '<div class="col-12"><div class="alert alert-info">Please configure Azure DevOps project first.</div></div>';
                return;
            }

            const days = document.getElementById('azuredevops-time-range').value;

            // Update Azure DevOps analytics summary (includes instant chart generation)
            await updateAzureDevOpsSummary(days);
            
            // Skip separate chart update - already done in updateAzureDevOpsSummary
            // Skip separate recent items update - already done in updateAzureDevOpsSummary
        }

        async function updateAzureDevOpsSummary(days) {
            // Step 1: Load work items first (fast)
            await loadWorkItemsSummary(days);
            
            // Step 2: Load PR data asynchronously (slower)
            loadPullRequestsData(days);
        }
        
        async function loadWorkItemsSummary(days) {
            // Show loading spinner for work items
            const container = document.getElementById('azuredevops-summary');
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-3">
                        <h6 class="text-muted">üìã Loading Work Items...</h6>
                        <small class="text-muted">Fetching work items for the last ${days} days</small>
                        <div class="progress mt-2" style="height: 4px; width: 250px; margin: 0 auto;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                 role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                console.log(`üìã Fetching work items summary for ${days} days...`);
                const startTime = performance.now();
                
                // Build query parameters
                const params = new URLSearchParams({
                    days: days,
                    org: azuredevopsOrg,
                    project: azuredevopsProject
                });
                
                if (azuredevopsAreaPath) {
                    params.append('area_path', azuredevopsAreaPath);
                }
                
                // Use work items only endpoint for fast loading
                const response = await fetch(`/api/azuredevops/workitems-summary?${params}`);
                const result = await response.json();
                
                const endTime = performance.now();
                const loadTime = (endTime - startTime).toFixed(2);
                console.log(`‚ö° Work items loaded in ${loadTime}ms`);

                if (result.status === 'success') {
                    // Cache the work items data (will be merged with PR data later)
                    azureDevOpsCache.set(result.data);
                    
                    displayAzureDevOpsSummary(result.data);
                    
                    // Update charts immediately with work items data
                    console.log('üìä Generating charts immediately with work items data...');
                    updateWorkItemsChartsInstant(result.data);
                    
                    // Display recent work items
                    displayRecentWorkItems(result.data.recent_work_items || []);
                    
                } else {
                    console.error('Error loading work items:', result.message);
                    displayAzureDevOpsError('Failed to load work items: ' + result.message);
                }
            } catch (error) {
                console.error('Error loading work items:', error);
                displayAzureDevOpsError('Error connecting to Azure DevOps API: ' + error.message);
            }
        }
        
        async function loadPullRequestsData(days) {
            // Show PR loading indicator
            showPRLoadingIndicator();
            
            try {
                console.log(`üîÑ Loading pull requests data for ${days} days...`);
                const startTime = performance.now();
                
                // Build query parameters
                const params = new URLSearchParams({
                    days: days,
                    org: azuredevopsOrg,
                    project: azuredevopsProject
                });
                
                if (azuredevopsAreaPath) {
                    params.append('area_path', azuredevopsAreaPath);
                }
                
                // Use detailed analytics endpoint for PR data
                const response = await fetch(`/api/azuredevops/analytics-detailed?${params}`);
                const result = await response.json();
                
                const endTime = performance.now();
                const loadTime = (endTime - startTime).toFixed(2);
                console.log(`‚ö° Pull requests data loaded in ${loadTime}ms`);

                if (result.status === 'success') {
                    // Cache the Azure DevOps data for fast sync
                    azureDevOpsCache.set(result.data);
                    
                    // Update PR and commit cards with detailed data
                    updatePRAndCommitCards(result.data);
                    
                    // Display recent pull requests and commits
                    if (typeof displayRecentPRsAndCommits === 'function') {
                        displayRecentPRsAndCommits(result.data.recent_pull_requests || [], result.data);
                    } else {
                        console.warn('displayRecentPRsAndCommits not available, using fallback');
                        displayRecentAzureDevOpsPRs(result.data.recent_pull_requests || []);
                    }
                    
                    // Hide PR loading indicator
                    hidePRLoadingIndicator();
                    
                    
                    console.log(`‚úÖ PR data loaded: ${result.data.total_pull_requests || 0} PRs, ${result.data.total_commits || 0} commits`);
                    
                } else {
                    console.error('Error loading pull requests:', result.message);
                    showPRLoadingError('Failed to load pull requests: ' + result.message);
                }
            } catch (error) {
                console.error('Error loading pull requests:', error);
                showPRLoadingError('Error loading pull requests: ' + error.message);
            }
        }
        
        function updateWorkItemsCharts(data) {
            // Update charts based on work items data only
            const chartTypeElement = document.getElementById('azuredevops-chart-type');
            
            if (!chartTypeElement) {
                console.error('Chart type selector not found: azuredevops-chart-type');
                return;
            }
            
            const chartType = chartTypeElement.value;
            
            let chartData;
            switch(chartType) {
                case 'workitem-type':
                    chartData = data.work_items_by_type || {};
                    break;
                case 'workitem-state':
                    chartData = data.work_items_by_state || {};
                    break;
                case 'workitem-assignee':
                    chartData = data.work_items_by_assignee || {};
                    break;
                default:
                    chartData = data.work_items_by_type || {};
            }
            
            // Generate chart
            generateWorkItemChart(chartData, chartType);
        }
        
        function updateWorkItemsChartsInstant(data) {
            // Instant chart generation - no delays, direct rendering
            console.log('‚ö° INSTANT: Starting immediate chart generation...');
            console.log('‚ö° INSTANT: Received data:', data);
            const startTime = performance.now();
            
            const chartTypeElement = document.getElementById('azuredevops-chart-type');
            
            if (!chartTypeElement) {
                console.error('Chart type selector not found: azuredevops-chart-type');
                // Use default chart type if selector not found
                const defaultChartType = 'workitem-type';
                const defaultChartData = data.work_items_by_type || {};
                console.log(`‚ö° INSTANT: Using default chart type: ${defaultChartType}`);
                generateWorkItemChartInstant(defaultChartData, defaultChartType);
                return;
            }
            
            const chartType = chartTypeElement.value;
            console.log(`‚ö° INSTANT: Chart type selected: ${chartType}`);
            
            let chartData;
            switch(chartType) {
                case 'workitem-type':
                    chartData = data.work_items_by_type || {};
                    console.log(`‚ö° INSTANT: Work items by type data:`, chartData);
                    break;
                case 'workitem-state':
                    chartData = data.work_items_by_state || {};
                    console.log(`‚ö° INSTANT: Work items by state data:`, chartData);
                    break;
                case 'workitem-assignee':
                    chartData = data.work_items_by_assignee || {};
                    console.log(`‚ö° INSTANT: Work items by assignee data:`, chartData);
                    break;
                default:
                    chartData = data.work_items_by_type || {};
                    console.log(`‚ö° INSTANT: Default work items by type data:`, chartData);
            }
            
            // Generate chart immediately
            generateWorkItemChartInstant(chartData, chartType);
            
            const endTime = performance.now();
            console.log(`‚ö° INSTANT: Chart generated in ${(endTime - startTime).toFixed(2)}ms`);
        }
        
        function generateWorkItemChart(data, chartType) {
            const chartContainer = document.getElementById('azuredevops-chart');
            
            // Check if chart container exists
            if (!chartContainer) {
                console.error('Chart container not found: azuredevops-chart');
                return;
            }
            
            // Check if data is valid
            if (!data || Object.keys(data).length === 0) {
                console.warn('No data provided for chart generation');
                chartContainer.innerHTML = '<div class="alert alert-info">No data available for chart</div>';
                return;
            }
            
            const labels = Object.keys(data);
            const values = Object.values(data);
            
            const chartTitle = {
                'workitem-type': 'Work Items by Type',
                'workitem-state': 'Work Items by State', 
                'workitem-assignee': 'Work Items by Assignee'
            }[chartType] || 'Work Items Distribution';
            
            const trace = {
                labels: labels,
                values: values,
                type: 'pie',
                marker: {
                    colors: ['#15616D', '#FFECD1', '#FF7D00', '#78290F', '#001524', '#2C2C2C', '#5A5A5A']
                }
            };
            
            const layout = {
                title: chartTitle,
                font: { family: 'Segoe UI, sans-serif' },
                showlegend: true,
                margin: { t: 50, b: 50, l: 50, r: 50 }
            };
            
            try {
                Plotly.newPlot(chartContainer, [trace], layout, {responsive: true});
            } catch (error) {
                console.error('Error creating chart:', error);
                chartContainer.innerHTML = '<div class="alert alert-danger">Error creating chart</div>';
            }
        }
        
        function generateWorkItemChartInstant(data, chartType) {
            console.log('‚ö° INSTANT CHART: Starting generation...');
            
            // First ensure the charts container exists and set up the chart div
            const chartsContainer = document.getElementById('azuredevops-charts-container');
            if (!chartsContainer) {
                console.error('Charts container not found: azuredevops-charts-container');
                return;
            }
            
            // Create the chart container if it doesn't exist
            let chartContainer = document.getElementById('azuredevops-chart');
            if (!chartContainer) {
                console.log('‚ö° INSTANT CHART: Creating chart container...');
                chartsContainer.innerHTML = `
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">Work Item Analytics</h5>
                            <small class="text-muted">üìä Instant Chart</small>
                        </div>
                        <div id="azuredevops-chart" style="height: 500px;"></div>
                    </div>
                `;
                chartContainer = document.getElementById('azuredevops-chart');
            }
            
            // Check if chart container exists now
            if (!chartContainer) {
                console.error('Chart container still not found after creation');
                return;
            }
            
            // Check if data is valid
            if (!data || Object.keys(data).length === 0) {
                console.warn('No data provided for instant chart generation');
                chartContainer.innerHTML = '<div class="alert alert-info">No data available for chart</div>';
                return;
            }
            
            const labels = Object.keys(data);
            const values = Object.values(data);
            console.log(`‚ö° INSTANT CHART: Labels: ${labels.join(', ')}`);
            console.log(`‚ö° INSTANT CHART: Values: ${values.join(', ')}`);
            
            const chartTitle = {
                'workitem-type': 'Work Items by Type',
                'workitem-state': 'Work Items by State', 
                'workitem-assignee': 'Work Items by Assignee'
            }[chartType] || 'Work Items Distribution';
            
            // Optimized trace for instant rendering
            const trace = {
                labels: labels,
                values: values,
                type: 'pie',
                marker: {
                    colors: ['#15616D', '#FFECD1', '#FF7D00', '#78290F', '#001524', '#2C2C2C', '#5A5A5A']
                },
                textinfo: 'label+percent',
                textposition: 'outside'
            };
            
            // Optimized layout for performance
            const layout = {
                title: {
                    text: chartTitle,
                    font: { family: 'Segoe UI, sans-serif', size: 16 }
                },
                font: { family: 'Segoe UI, sans-serif', size: 12 },
                showlegend: true,
                margin: { t: 50, b: 50, l: 50, r: 50 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };
            
            // Optimized config for instant rendering
            const config = {
                responsive: true,
                displayModeBar: false,
                staticPlot: false
            };
            
            try {
                console.log('‚ö° INSTANT CHART: Calling Plotly.newPlot...');
                Plotly.newPlot(chartContainer, [trace], layout, config);
                console.log('‚ö° INSTANT CHART: Chart rendered successfully!');
            } catch (error) {
                console.error('Error creating instant chart:', error);
                chartContainer.innerHTML = '<div class="alert alert-danger">Error creating chart</div>';
            }
        }
        
        function showPRLoadingIndicator() {
            // Show loading message in PR container (cards now show loading state directly)
            const prContainer = document.getElementById('recent-azuredevops-prs-container');
            if (prContainer) {
                prContainer.innerHTML = `
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div>
                                <strong>Loading Pull Requests...</strong><br>
                                <small>Analyzing work item relations and extracting PR data</small>
                            </div>
                        </div>
                        <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                 role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                `;
            } else {
                console.warn('PR container not found for loading indicator');
            }
            
            console.log('üìä PR loading indicator shown - cards display loading state directly');
        }
        
        function hidePRLoadingIndicator() {
            // Remove loading indicators - cards will be updated by updatePRAndCommitCards
            console.log('‚úÖ PR loading completed');
        }
        
        function showPRLoadingError(message) {
            const prContainer = document.getElementById('recent-azuredevops-prs-container');
            if (prContainer) {
                prContainer.innerHTML = `<div class="alert alert-danger">${message}</div>`;
            }
        }
        
        function updatePRAndCommitCards(data) {
            console.log('üîÑ Updating PR and Commit cards with final data:', data);
            
            // Update the PR and Commits cards with actual data
            const prCard = document.querySelector('[data-card="pull-requests"]');
            const commitCard = document.querySelector('[data-card="commits"]');
            const repoCard = document.querySelector('[data-card="repositories"]');
            
            if (prCard) {
                prCard.innerHTML = `
                    <div class="card-body text-center">
                        <i class="fas fa-code-branch fa-2x text-success mb-2"></i>
                        <h5 class="card-title">${data.total_pull_requests || 0}</h5>
                        <p class="card-text text-muted">Pull Requests</p>
                        <small class="text-muted">Linked to work items</small>
                    </div>
                `;
                console.log(`‚úÖ Updated PR card: ${data.total_pull_requests || 0} PRs`);
            } else {
                console.warn('PR card not found for update');
            }
            
            if (commitCard) {
                commitCard.innerHTML = `
                    <div class="card-body text-center">
                        <i class="fas fa-commit fa-2x text-info mb-2"></i>
                        <h5 class="card-title">${data.total_commits || 0}</h5>
                        <p class="card-text text-muted">Commits</p>
                        <small class="text-muted">Code changes</small>
                    </div>
                `;
                console.log(`‚úÖ Updated Commits card: ${data.total_commits || 0} commits`);
            } else {
                console.warn('Commits card not found for update');
            }
            
            if (repoCard) {
                repoCard.innerHTML = `
                    <div class="card-body text-center">
                        <i class="fas fa-folder-open fa-2x text-warning mb-2"></i>
                        <h5 class="card-title">${data.total_repositories || 0}</h5>
                        <p class="card-text text-muted">Repositories</p>
                        <small class="text-muted">Active repos</small>
                    </div>
                `;
                console.log(`‚úÖ Updated Repositories card: ${data.total_repositories || 0} repos`);
            } else {
                console.warn('Repositories card not found for update');
            }
        }

        function displayAzureDevOpsSummary(data) {
            const container = document.getElementById('azuredevops-summary');
            container.innerHTML = '';

            const summaryCards = [
                {
                    title: 'Work Items',
                    value: data.total_work_items,
                    icon: 'fas fa-tasks',
                    color: 'primary',
                    subtitle: `Last ${document.getElementById('azuredevops-time-range').value} days`
                },
                {
                    title: 'Pull Requests',
                    value: data.pr_loading ? 'Loading...' : (data.total_pull_requests || 0),
                    icon: 'fas fa-code-branch',
                    color: data.pr_loading ? 'secondary' : 'success',
                    subtitle: data.pr_loading ? 'Analyzing work items...' : 'Linked to work items',
                    loading: data.pr_loading
                },
                {
                    title: 'Commits',
                    value: data.pr_loading ? 'Loading...' : (data.total_commits || 0),
                    icon: 'fas fa-commit',
                    color: data.pr_loading ? 'secondary' : 'info',
                    subtitle: data.pr_loading ? 'Extracting from PRs...' : 'Code changes',
                    loading: data.pr_loading
                },
                {
                    title: 'Repositories',
                    value: data.pr_loading ? 'Loading...' : (data.total_repositories || 0),
                    icon: 'fas fa-folder-open',
                    color: data.pr_loading ? 'secondary' : 'warning',
                    subtitle: data.pr_loading ? 'Discovering repos...' : 'Active repos',
                    loading: data.pr_loading
                }
            ];

            summaryCards.forEach(card => {
                const col = document.createElement('div');
                col.className = 'col-md-3 mb-3';
                
                // Add data attribute for card identification
                const cardType = card.title.toLowerCase().replace(/\s+/g, '-');
                
                col.innerHTML = `
                    <div class="card metric-card h-100" data-card="${cardType}">
                        <div class="card-body text-center">
                            ${card.loading ? 
                                `<div class="spinner-border spinner-border-sm text-${card.color} mb-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>` : 
                                `<i class="${card.icon} fa-2x text-${card.color} mb-2"></i>`
                            }
                            <h5 class="card-title">${card.value}</h5>
                            <p class="card-text text-muted">${card.title}</p>
                            ${card.subtitle ? `<small class="text-muted">${card.subtitle}</small>` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        function displayAzureDevOpsError(message) {
            const container = document.getElementById('azuredevops-summary');
            container.innerHTML = `<div class="col-12"><div class="alert alert-danger">${message}</div></div>`;
        }

        async function updateAzureDevOpsCharts(days, chartType) {
            const container = document.getElementById('azuredevops-charts-container');
            const analysisMode = document.getElementById('azuredevops-analysis-mode').value;
            const isDetailedMode = analysisMode === 'detailed';
            
            // Show loading for charts
            container.innerHTML = `
                <div class="col-12 text-center py-4">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Loading chart...</span>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Generating ${chartType} chart...</small>
                    </div>
                </div>
            `;

            try {
                // Build query parameters
                const params = new URLSearchParams({
                    days: days,
                    type: chartType,
                    org: azuredevopsOrg,
                    project: azuredevopsProject
                });
                
                if (azuredevopsAreaPath) {
                    params.append('area_path', azuredevopsAreaPath);
                }
                
                // Add analysis mode parameter for backend to use appropriate data
                if (isDetailedMode) {
                    params.append('detailed', 'true');
                }
                
                const response = await fetch(`/api/azuredevops/chart?${params}`);
                const result = await response.json();

                if (result.status === 'success') {
                    const chartDiv = document.createElement('div');
                    chartDiv.className = 'col-12 mb-4';
                    chartDiv.innerHTML = `
                        <div class="chart-container">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">${getChartTitle(chartType)}</h5>
                                <small class="text-muted">${isDetailedMode ? 'üîç Detailed Analysis' : 'üöÄ Fast Mode'}</small>
                            </div>
                            <div id="azuredevops-chart" style="height: 500px;"></div>
                        </div>
                    `;
                    container.innerHTML = '';
                    container.appendChild(chartDiv);

                    // Render the chart
                    const chartData = JSON.parse(result.chart);
                    Plotly.newPlot('azuredevops-chart', chartData.data, chartData.layout, {responsive: true});
                } else {
                    console.error('Error loading Azure DevOps chart:', result.message);
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> 
                                Chart Error: ${result.message || 'No data available for selected chart type'}
                                <br><small>Try switching to detailed mode for PR/repository charts.</small>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error updating Azure DevOps charts:', error);
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle"></i> 
                            Failed to load chart: ${error.message}
                        </div>
                    </div>
                `;
            }
        }
        
        function getChartTitle(chartType) {
            const titles = {
                'overview': 'üìä Activity Overview',
                'work_items_by_type': 'üè∑Ô∏è Work Items by Type',
                'work_items_by_state': 'üìã Work Items by State', 
                'work_items_by_assignee': 'üë§ Work Items by Assignee',
                'prs_by_status': 'üîÄ Pull Requests by Status',
                'repositories_breakdown': 'üìÅ Repository Breakdown'
            };
            return titles[chartType] || 'üìä Azure DevOps Chart';
        }

        async function updateRecentAzureDevOpsItems(days) {
            try {
                // Build query parameters
                const params = new URLSearchParams({
                    days: days,
                    org: azuredevopsOrg,
                    project: azuredevopsProject
                });
                
                if (azuredevopsAreaPath) {
                    params.append('area_path', azuredevopsAreaPath);
                }
                
                const response = await fetch(`/api/azuredevops/analytics?${params}`);
                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    displayRecentWorkItems(result.data.recent_work_items || []);
                    displayRecentAzureDevOpsPRs(result.data.recent_pull_requests || []);
                } else {
                    document.getElementById('recent-workitems-container').innerHTML = '<div class="alert alert-info">No recent work items found.</div>';
                    document.getElementById('recent-azuredevops-prs-container').innerHTML = '<div class="alert alert-info">No recent pull requests found.</div>';
                }
            } catch (error) {
                console.error('Error loading recent Azure DevOps items:', error);
                document.getElementById('recent-workitems-container').innerHTML = '<div class="alert alert-danger">Error loading recent work items</div>';
                document.getElementById('recent-azuredevops-prs-container').innerHTML = '<div class="alert alert-danger">Error loading recent pull requests</div>';
            }
        }

        function displayRecentWorkItems(workItems) {
            const container = document.getElementById('recent-workitems-container');
            container.innerHTML = '';

            workItems.forEach(item => {
                const fields = item.fields || {};
                const workItemDiv = document.createElement('div');
                workItemDiv.className = 'card mb-2';
                
                const stateClass = fields['System.State'] === 'Active' ? 'success' : 
                                 fields['System.State'] === 'Resolved' ? 'warning' : 'secondary';
                
                workItemDiv.innerHTML = `
                    <div class="card-body p-2">
                        <div class="row">
                            <div class="col-8">
                                <h6 class="card-title mb-1">
                                    <a href="https://dev.azure.com/${azuredevopsOrg}/${azuredevopsProject}/_workitems/edit/${item.id}" target="_blank" class="text-decoration-none">
                                        #${item.id} ${fields['System.Title'] || 'No Title'}
                                    </a>
                                </h6>
                                <small class="text-muted">${fields['System.WorkItemType'] || 'Unknown'}</small>
                            </div>
                            <div class="col-4 text-end">
                                <span class="badge bg-${stateClass}">${fields['System.State'] || 'Unknown'}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(workItemDiv);
            });
        }

        function displayRecentAzureDevOpsPRs(prs) {
            const container = document.getElementById('recent-azuredevops-prs-container');
            container.innerHTML = '';

            prs.forEach(pr => {
                const prDiv = document.createElement('div');
                prDiv.className = 'card mb-2';
                
                const statusClass = pr.status === 'active' ? 'success' : 
                                  pr.status === 'completed' ? 'primary' : 'secondary';
                
                prDiv.innerHTML = `
                    <div class="card-body p-2">
                        <div class="row">
                            <div class="col-8">
                                <h6 class="card-title mb-1">
                                    <a href="${pr.url}" target="_blank" class="text-decoration-none">
                                        #${pr.pullRequestId} ${pr.title || 'No Title'}
                                    </a>
                                </h6>
                                <small class="text-muted">By ${pr.createdBy?.displayName || 'Unknown'}</small>
                            </div>
                            <div class="col-4 text-end">
                                <span class="badge bg-${statusClass}">${pr.status}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(prDiv);
            });
        }

        function displayRecentPRsAndCommits(prs, data) {
            console.log('üîÑ Displaying recent PRs and commits:', { prs: prs.length, data });
            const container = document.getElementById('recent-azuredevops-prs-container');
            container.innerHTML = '';

            // Combine PRs and commits from work items
            let allItems = [];
            
            // Add PRs
            if (prs && prs.length > 0) {
                prs.forEach(pr => {
                    allItems.push({
                        type: 'pr',
                        title: pr.title || `PR #${pr.pullRequestId || 'N/A'}`,
                        url: pr.url || '#',
                        repository: pr.repository?.name || 'Unknown',
                        date: pr.creationDate || pr.date,
                        work_item_title: pr.work_item_title || '',
                        author: pr.createdBy?.displayName || 'Unknown'
                    });
                });
            }
            
            // Extract commits from work items if available
            if (data.recent_work_items) {
                data.recent_work_items.forEach(workItem => {
                    const associatedPrs = workItem.associated_prs || [];
                    associatedPrs.forEach(item => {
                        if (item.relation_type === 'commit') {
                            allItems.push({
                                type: 'commit',
                                title: `Commit ${item.commit_id ? item.commit_id.substring(0, 8) : 'N/A'}`,
                                url: item.url || '#',
                                repository: item.repository || 'Unknown',
                                date: workItem.fields?.['System.ChangedDate'] || workItem.fields?.['System.CreatedDate'],
                                work_item_title: workItem.fields?.['System.Title'] || '',
                                author: 'Unknown'
                            });
                        } else if (item.relation_type === 'pr') {
                            // Add PRs from work items too
                            allItems.push({
                                type: 'pr',
                                title: `PR #${item.pr_number || 'N/A'}`,
                                url: item.url || '#',
                                repository: item.repository || 'Unknown',
                                date: workItem.fields?.['System.ChangedDate'] || workItem.fields?.['System.CreatedDate'],
                                work_item_title: workItem.fields?.['System.Title'] || '',
                                author: 'Unknown'
                            });
                        }
                    });
                });
            }
            
            // Sort by date (most recent first) and limit to 10
            allItems.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
            allItems = allItems.slice(0, 10);
            
            console.log(`üìä Displaying ${allItems.length} recent PRs and commits`);
            
            if (allItems.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No recent pull requests or commits found.</div>';
                return;
            }
            
            allItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'card mb-2';
                
                const badgeClass = item.type === 'pr' ? 'bg-success' : 'bg-info';
                const badgeText = item.type === 'pr' ? 'PR' : 'Commit';
                const icon = item.type === 'pr' ? 'fas fa-code-branch' : 'fas fa-commit';
                
                itemDiv.innerHTML = `
                    <div class="card-body p-2">
                        <div class="row">
                            <div class="col-8">
                                <h6 class="card-title mb-1">
                                    <i class="${icon} me-1"></i>
                                    <a href="${item.url}" target="_blank" class="text-decoration-none">
                                        ${item.title}
                                    </a>
                                </h6>
                                <small class="text-muted">Repository: ${item.repository}</small>
                                ${item.work_item_title ? `<br><small class="text-muted">Work Item: ${item.work_item_title}</small>` : ''}
                            </div>
                            <div class="col-4 text-end">
                                <span class="badge ${badgeClass}">${badgeText}</span>
                                <br>
                                <small class="text-muted">${new Date(item.date || Date.now()).toLocaleDateString()}</small>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }
        
        // Update sync button to show cache status
        function updateSyncButtonStatus() {
            const syncButton = document.getElementById('sync-azure-devops-btn');
            if (!syncButton) return;
            
            const cachedData = azureDevOpsCache.get();
            if (cachedData && cachedData.resolved_repositories) {
                syncButton.innerHTML = `
                    <i class="fab fa-microsoft"></i> <i class="fas fa-arrow-right"></i> <i class="fab fa-github"></i> 
                    Sync from Azure DevOps <span class="badge bg-success ms-1">‚ö° Fast</span>
                `;
                syncButton.title = 'Repositories available in cache - instant sync!';
            } else {
                syncButton.innerHTML = `
                    <i class="fab fa-microsoft"></i> <i class="fas fa-arrow-right"></i> <i class="fab fa-github"></i> 
                    Sync from Azure DevOps
                `;
                syncButton.title = 'Load data in Azure DevOps tab first for faster sync';
            }
        }
        


        // Figma Analytics Functions
        let figmaConfigured = false;
        let figmaTeamId = '';

        function configureFigma() {
            const teamId = document.getElementById('figma-team-id').value.trim();
            
            if (!teamId) {
                alert('Please enter your Figma Team ID');
                return;
            }
            
            figmaTeamId = teamId;
            figmaConfigured = true;
            
            document.getElementById('figma-team-info').textContent = teamId;
            
            // Update Figma dashboard
            updateFigmaDashboard();
        }

        async function updateFigmaDashboard() {
            if (!figmaConfigured) {
                document.getElementById('figma-summary').innerHTML = '<div class="col-12"><div class="alert alert-info">Please configure Figma team first.</div></div>';
                return;
            }

            const days = document.getElementById('figma-time-range').value;
            const chartType = document.getElementById('figma-chart-type').value;

            // Update Figma analytics summary
            await updateFigmaSummary(days);
            
            // Update Figma charts
            await updateFigmaCharts(days, chartType);
            
            // Update recent items
            await updateRecentFigmaItems(days);
        }

        async function updateFigmaSummary(days) {
            try {
                const response = await fetch(`/api/figma/analytics?days=${days}`);
                const result = await response.json();

                if (result.status === 'success') {
                    displayFigmaSummary(result.data);
                } else {
                    console.error('Error updating Figma summary:', result.message);
                    displayFigmaError('Failed to load Figma analytics: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating Figma summary:', error);
                displayFigmaError('Error connecting to Figma API');
            }
        }

        function displayFigmaSummary(data) {
            const container = document.getElementById('figma-summary');
            container.innerHTML = '';

            const summaryCards = [
                {
                    title: 'Projects',
                    value: data.total_projects,
                    icon: 'fas fa-folder',
                    color: 'primary'
                },
                {
                    title: 'Files',
                    value: data.total_files,
                    icon: 'fas fa-file',
                    color: 'success'
                },
                {
                    title: 'Comments',
                    value: data.total_comments,
                    icon: 'fas fa-comments',
                    color: 'warning'
                },
                {
                    title: 'Collaborators',
                    value: data.active_collaborators.length,
                    icon: 'fas fa-users',
                    color: 'info'
                }
            ];

            summaryCards.forEach(card => {
                const col = document.createElement('div');
                col.className = 'col-md-3 mb-3';
                col.innerHTML = `
                    <div class="card metric-card h-100">
                        <div class="card-body text-center">
                            <i class="${card.icon} fa-2x text-${card.color} mb-2"></i>
                            <h5 class="card-title">${card.value}</h5>
                            <p class="card-text text-muted">${card.title}</p>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        function displayFigmaError(message) {
            const container = document.getElementById('figma-summary');
            container.innerHTML = `<div class="col-12"><div class="alert alert-danger">${message}</div></div>`;
        }

        async function updateFigmaCharts(days, chartType) {
            const container = document.getElementById('figma-charts-container');
            container.innerHTML = '';

            try {
                const response = await fetch(`/api/figma/chart?days=${days}&type=${chartType}`);
                const result = await response.json();

                if (result.status === 'success') {
                    const chartDiv = document.createElement('div');
                    chartDiv.className = 'col-12 mb-4';
                    chartDiv.innerHTML = `
                        <div class="chart-container">
                            <div id="figma-chart" style="height: 500px;"></div>
                        </div>
                    `;
                    container.appendChild(chartDiv);

                    // Render the chart
                    const chartData = JSON.parse(result.chart);
                    Plotly.newPlot('figma-chart', chartData.data, chartData.layout);
                } else {
                    console.error('Error loading Figma chart:', result.message);
                    container.innerHTML = '<div class="col-12"><div class="alert alert-warning">No data available for Figma analytics</div></div>';
                }
            } catch (error) {
                console.error('Error loading Figma chart:', error);
                container.innerHTML = '<div class="col-12"><div class="alert alert-danger">Error loading Figma chart</div></div>';
            }
        }

        async function updateRecentFigmaItems(days) {
            try {
                const response = await fetch(`/api/figma/analytics?days=${days}`);
                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    displayRecentFigmaFiles(result.data.recent_files || []);
                    displayFigmaCollaborators(result.data.active_collaborators || []);
                } else {
                    document.getElementById('recent-figma-files-container').innerHTML = '<div class="alert alert-info">No recent files found.</div>';
                    document.getElementById('figma-collaborators-container').innerHTML = '<div class="alert alert-info">No collaborators found.</div>';
                }
            } catch (error) {
                console.error('Error loading recent Figma items:', error);
                document.getElementById('recent-figma-files-container').innerHTML = '<div class="alert alert-danger">Error loading recent files</div>';
                document.getElementById('figma-collaborators-container').innerHTML = '<div class="alert alert-danger">Error loading collaborators</div>';
            }
        }

        function displayRecentFigmaFiles(files) {
            const container = document.getElementById('recent-figma-files-container');
            container.innerHTML = '';

            files.slice(0, 10).forEach(file => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'card mb-2';
                
                fileDiv.innerHTML = `
                    <div class="card-body p-2">
                        <div class="row">
                            <div class="col-8">
                                <h6 class="card-title mb-1">
                                    <a href="https://www.figma.com/file/${file.key}" target="_blank" class="text-decoration-none">
                                        ${file.name || 'Untitled'}
                                    </a>
                                </h6>
                                <small class="text-muted">${file.comments_count || 0} comments</small>
                            </div>
                            <div class="col-4 text-end">
                                <small class="text-muted">v${file.version || '1'}</small>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(fileDiv);
            });
        }

        function displayFigmaCollaborators(collaborators) {
            const container = document.getElementById('figma-collaborators-container');
            container.innerHTML = '';

            collaborators.forEach(collaborator => {
                const collaboratorDiv = document.createElement('div');
                collaboratorDiv.className = 'card mb-2';
                
                collaboratorDiv.innerHTML = `
                    <div class="card-body p-2">
                        <div class="d-flex align-items-center">
                            <div class="avatar bg-primary text-white rounded-circle me-2" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                ${collaborator.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h6 class="mb-0">${collaborator}</h6>
                                <small class="text-muted">Active collaborator</small>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(collaboratorDiv);
            });
        }

        async function searchFigmaFiles() {
            const query = document.getElementById('figma-search').value.trim();
            
            if (!query) {
                alert('Please enter a search term');
                return;
            }

            try {
                const response = await fetch(`/api/figma/search?q=${encodeURIComponent(query)}`);
                const result = await response.json();

                if (result.status === 'success') {
                    displayFigmaSearchResults(result.data);
                } else {
                    console.error('Error searching Figma files:', result.message);
                    document.getElementById('figma-search-results-container').innerHTML = '<div class="alert alert-danger">Search failed: ' + result.message + '</div>';
                }
            } catch (error) {
                console.error('Error searching Figma files:', error);
                document.getElementById('figma-search-results-container').innerHTML = '<div class="alert alert-danger">Error searching files</div>';
            }
        }

        function displayFigmaSearchResults(results) {
            const container = document.getElementById('figma-search-results-container');
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No files found matching your search.</div>';
                return;
            }

            results.forEach(file => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'card mb-2';
                
                fileDiv.innerHTML = `
                    <div class="card-body p-2">
                        <div class="row">
                            <div class="col-8">
                                <h6 class="card-title mb-1">
                                    <a href="https://www.figma.com/file/${file.key}" target="_blank" class="text-decoration-none">
                                        ${file.name || 'Untitled'}
                                    </a>
                                </h6>
                                <small class="text-muted">Project: ${file.project || 'Unknown'}</small>
                            </div>
                            <div class="col-4 text-end">
                                <small class="text-muted">${new Date(file.last_modified).toLocaleDateString()}</small>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(fileDiv);
            });
        }

        // Datadog Logs Functions
        async function loadLogsSummary() {
            try {
                const hours = document.getElementById('logs-time-range')?.value || 24;
                const response = await fetch(`/api/datadog/logs/summary?hours=${hours}`);
                const result = await response.json();

                if (result.status === 'success') {
                    displayLogsSummary(result.data);
                } else {
                    console.error('Error loading logs summary:', result.message);
                    displayLogsError('Failed to load logs summary: ' + result.message);
                }
            } catch (error) {
                console.error('Error loading logs summary:', error);
                displayLogsError('Error connecting to logs API');
            }
        }

        function displayLogsSummary(data) {
            const container = document.getElementById('logs-summary');
            container.innerHTML = '';

            // Total Logs Card
            const totalCard = document.createElement('div');
            totalCard.className = 'col-md-3 mb-3';
            totalCard.innerHTML = `
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title">${data.total_logs.toLocaleString()}</h4>
                                <p class="card-text">Total Logs</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-file-alt fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(totalCard);

            // Log Levels Cards
            Object.entries(data.log_levels).forEach(([level, count]) => {
                const levelCard = document.createElement('div');
                levelCard.className = 'col-md-3 mb-3';
                
                let bgColor = 'bg-info';
                let icon = 'fas fa-info-circle';
                if (level === 'error') {
                    bgColor = 'bg-danger';
                    icon = 'fas fa-exclamation-triangle';
                } else if (level === 'warning') {
                    bgColor = 'bg-warning';
                    icon = 'fas fa-exclamation-circle';
                } else if (level === 'debug') {
                    bgColor = 'bg-secondary';
                    icon = 'fas fa-bug';
                }

                levelCard.innerHTML = `
                    <div class="card text-white ${bgColor}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">${count.toLocaleString()}</h4>
                                    <p class="card-text">${level.charAt(0).toUpperCase() + level.slice(1)}</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="${icon} fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(levelCard);
            });
        }

        async function searchLogs() {
            try {
                const query = document.getElementById('logs-search-query').value || '*';
                const hours = document.getElementById('logs-time-range').value || 24;
                const service = document.getElementById('logs-service-filter').value || '';
                const level = document.getElementById('logs-level-filter').value || '';

                const params = new URLSearchParams();
                params.append('q', query);
                params.append('hours', hours);
                if (service) params.append('service', service);
                if (level) params.append('level', level);

                const response = await fetch(`/api/datadog/logs/search?${params}`);
                const result = await response.json();

                if (result.status === 'success') {
                    displayLogs(result.data);
                } else {
                    console.error('Error searching logs:', result.message);
                    displayLogsError('Failed to search logs: ' + result.message);
                }
            } catch (error) {
                console.error('Error searching logs:', error);
                displayLogsError('Error connecting to logs API');
            }
        }

        function displayLogs(logsData) {
            const container = document.getElementById('logs-list');
            container.innerHTML = '';

            if (!logsData || !logsData.data || logsData.data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No logs found for the selected criteria.</div>';
                return;
            }

            logsData.data.forEach(log => {
                const logDiv = document.createElement('div');
                logDiv.className = 'card mb-2';
                
                const attributes = log.attributes || {};
                const timestamp = attributes.timestamp ? new Date(attributes.timestamp).toLocaleString() : 'Unknown time';
                const level = attributes.level || 'info';
                const service = attributes.service || 'unknown';
                const message = attributes.message || attributes.msg || 'No message';
                const host = attributes.host || attributes.hostname || 'unknown';

                let levelClass = 'badge bg-info';
                if (level === 'error' || level === 'ERROR') levelClass = 'badge bg-danger';
                else if (level === 'warning' || level === 'WARN') levelClass = 'badge bg-warning';
                else if (level === 'debug' || level === 'DEBUG') levelClass = 'badge bg-secondary';
                else if (level === 'critical' || level === 'CRITICAL') levelClass = 'badge bg-dark';

                // Truncate long messages
                const displayMessage = message.length > 100 ? message.substring(0, 100) + '...' : message;

                logDiv.innerHTML = `
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-md-1">
                                <span class="${levelClass}">${level.toUpperCase()}</span>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted"><strong>Service:</strong> ${service}</small>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted"><strong>Host:</strong> ${host}</small>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted"><strong>Time:</strong> ${timestamp}</small>
                            </div>
                            <div class="col-md-5">
                                <small><strong>Message:</strong> ${displayMessage}</small>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(logDiv);
            });

            // Add a summary at the top
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'alert alert-success mb-3';
            summaryDiv.innerHTML = `<i class="fas fa-info-circle"></i> Found ${logsData.data.length} logs from your Datadog account`;
            container.insertBefore(summaryDiv, container.firstChild);
        }

        function displayLogsError(message) {
            const container = document.getElementById('logs-list');
            container.innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }

        function refreshLogsSummary() {
            loadLogsSummary();
        }

        async function loadAllLogs() {
            try {
                const hours = document.getElementById('logs-time-range')?.value || 24;
                const response = await fetch(`/api/datadog/logs/search?q=*&hours=${hours}&limit=50`);
                const result = await response.json();

                if (result.status === 'success') {
                    displayLogs(result.data);
                } else {
                    console.error('Error loading all logs:', result.message);
                    displayLogsError('Failed to load logs: ' + result.message);
                }
            } catch (error) {
                console.error('Error loading all logs:', error);
                displayLogsError('Error connecting to logs API');
            }
        }

        // Load available services for logs
        async function loadAvailableServices() {
            try {
                const response = await fetch('/api/datadog/services');
                const result = await response.json();
                
                if (result.status === 'success') {
                    const serviceSelect = document.getElementById('logs-service-filter');
                    // Clear existing options except "All Services"
                    serviceSelect.innerHTML = '<option value="">All Services</option>';
                    
                    // Add services from Datadog
                    result.data.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service;
                        option.textContent = service;
                        serviceSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading services:', error);
            }
        }


        // Dashboard Functions
        async function loadAllDashboards() {
            try {
                const response = await fetch('/api/datadog/dashboards');
                const result = await response.json();

                if (result.status === 'success') {
                    displayDashboardsSummary(result.data);
                    displayDashboardsList(result.data);
                } else {
                    console.error('Error loading dashboards:', result.message);
                    displayDashboardsError('Failed to load dashboards: ' + result.message);
                }
            } catch (error) {
                console.error('Error loading dashboards:', error);
                displayDashboardsError('Error connecting to Datadog API');
            }
        }

        async function loadDashboardsSummary() {
            // Legacy function - redirect to loadAllDashboards
            await loadAllDashboards();
        }

        function displayDashboardsSummary(data) {
            const container = document.getElementById('dashboards-summary');
            container.innerHTML = '';

            const dashboards = data.dashboards || [];
            const totalDashboards = dashboards.length;
            const readOnlyDashboards = dashboards.filter(d => d.is_read_only).length;
            const editableDashboards = totalDashboards - readOnlyDashboards;

            const summaryCards = [
                {
                    title: 'Total Dashboards',
                    value: totalDashboards,
                    icon: 'fas fa-tachometer-alt',
                    color: 'primary'
                },
                {
                    title: 'Editable',
                    value: editableDashboards,
                    icon: 'fas fa-edit',
                    color: 'success'
                },
                {
                    title: 'Read Only',
                    value: readOnlyDashboards,
                    icon: 'fas fa-lock',
                    color: 'warning'
                },
                {
                    title: 'Widgets',
                    value: dashboards.reduce((total, d) => total + (d.widgets ? d.widgets.length : 0), 0),
                    icon: 'fas fa-chart-bar',
                    color: 'info'
                }
            ];

            summaryCards.forEach(card => {
                const col = document.createElement('div');
                col.className = 'col-md-3 mb-3';
                col.innerHTML = `
                    <div class="card metric-card h-100">
                        <div class="card-body text-center">
                            <i class="${card.icon} fa-2x text-${card.color} mb-2"></i>
                            <h5 class="card-title">${card.value}</h5>
                            <p class="card-text text-muted">${card.title}</p>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        function displayDashboardsList(data) {
            const container = document.getElementById('dashboards-list');
            container.innerHTML = '';

            const dashboards = data.dashboards || [];

            if (dashboards.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No dashboards found in your Datadog account.</div>';
                return;
            }

            dashboards.forEach(dashboard => {
                const dashboardDiv = document.createElement('div');
                dashboardDiv.className = 'card mb-3';
                
                const readOnlyBadge = dashboard.is_read_only ? 
                    '<span class="badge bg-warning ms-2"><i class="fas fa-lock"></i> Read Only</span>' : 
                    '<span class="badge bg-success ms-2"><i class="fas fa-edit"></i> Editable</span>';
                
                const widgetCount = dashboard.widgets ? dashboard.widgets.length : 0;
                const createdDate = new Date(dashboard.created_at).toLocaleDateString();
                const modifiedDate = new Date(dashboard.modified_at).toLocaleDateString();

                dashboardDiv.innerHTML = `
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="card-title">
                                    <a href="${dashboard.url}" target="_blank" class="text-decoration-none">
                                        ${dashboard.title}
                                    </a>
                                    ${readOnlyBadge}
                                </h6>
                                <p class="card-text text-muted">${dashboard.description || 'No description available'}</p>
                                <div class="row">
                                    <div class="col-md-4">
                                        <small class="text-muted"><strong>Author:</strong> ${dashboard.author_name}</small>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted"><strong>Widgets:</strong> ${widgetCount}</small>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted"><strong>Modified:</strong> ${modifiedDate}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-primary btn-sm mb-2" onclick="loadDashboardDetails('${dashboard.id}')">
                                    <i class="fas fa-info-circle"></i> View Details
                                </button>
                                <br>
                                <a href="${dashboard.url}" target="_blank" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-external-link-alt"></i> Open in Datadog
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(dashboardDiv);
            });
        }

        function displayDashboardsError(message) {
            const container = document.getElementById('dashboards-list');
            container.innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }

        async function loadDashboardDetails(dashboardId = null) {
            if (!dashboardId) {
                const input = document.getElementById('dashboard-id-input');
                dashboardId = input.value.trim();
                
                if (!dashboardId) {
                    alert('Please enter a dashboard ID');
                    return;
                }
            }

            try {
                const response = await fetch(`/api/datadog/dashboards/${dashboardId}`);
                const result = await response.json();

                if (result.status === 'success') {
                    displayDashboardDetails(result.data);
                } else {
                    console.error('Error loading dashboard details:', result.message);
                    displayDashboardDetailsError('Failed to load dashboard details: ' + result.message);
                }
            } catch (error) {
                console.error('Error loading dashboard details:', error);
                displayDashboardDetailsError('Error connecting to Datadog API');
            }
        }

        function displayDashboardDetails(dashboard) {
            const container = document.getElementById('dashboard-details');
            container.innerHTML = '';

            const readOnlyBadge = dashboard.is_read_only ? 
                '<span class="badge bg-warning"><i class="fas fa-lock"></i> Read Only</span>' : 
                '<span class="badge bg-success"><i class="fas fa-edit"></i> Editable</span>';

            const createdDate = new Date(dashboard.created_at).toLocaleString();
            const modifiedDate = new Date(dashboard.modified_at).toLocaleString();

            let widgetsHtml = '';
            if (dashboard.widgets && dashboard.widgets.length > 0) {
                widgetsHtml = '<h6 class="mt-3">Widgets:</h6><ul class="list-group">';
                dashboard.widgets.forEach(widget => {
                    const widgetDef = widget.definition || {};
                    widgetsHtml += `
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${widgetDef.title || 'Untitled Widget'}</strong>
                                    <br>
                                    <small class="text-muted">Type: ${widgetDef.type || 'Unknown'}</small>
                                </div>
                                <span class="badge bg-secondary">ID: ${widget.id}</span>
                            </div>
                        </li>
                    `;
                });
                widgetsHtml += '</ul>';
            } else {
                widgetsHtml = '<div class="alert alert-info">No widgets found in this dashboard.</div>';
            }

            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            ${dashboard.title}
                            ${readOnlyBadge}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Description:</strong> ${dashboard.description || 'No description available'}</p>
                                <p><strong>Author:</strong> ${dashboard.author_name}</p>
                                <p><strong>Created:</strong> ${createdDate}</p>
                                <p><strong>Modified:</strong> ${modifiedDate}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Dashboard ID:</strong> <code>${dashboard.id}</code></p>
                                <p><strong>URL:</strong> <a href="${dashboard.url}" target="_blank">${dashboard.url}</a></p>
                                <p><strong>Widget Count:</strong> ${dashboard.widgets ? dashboard.widgets.length : 0}</p>
                            </div>
                        </div>
                        ${widgetsHtml}
                    </div>
                </div>
            `;
        }

        function displayDashboardDetailsError(message) {
            const container = document.getElementById('dashboard-details');
            container.innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }

        async function loadSpecificDashboard() {
            const dashboardId = document.getElementById('dashboard-id-input').value.trim();
            if (!dashboardId) {
                alert('Please enter a dashboard ID');
                return;
            }
            await loadDashboardDetails(dashboardId);
        }

        // Add event listeners for logs and dashboards tabs
        document.addEventListener('DOMContentLoaded', function() {
            const datadogLogsTab = document.getElementById('datadog-logs-tab');
            if (datadogLogsTab) {
                datadogLogsTab.addEventListener('click', function() {
                    loadLogsSummary();
                    loadAvailableServices();
                });
            }

            const datadogDashboardsTab = document.getElementById('datadog-dashboards-tab');
            if (datadogDashboardsTab) {
                datadogDashboardsTab.addEventListener('click', function() {
                    loadAllDashboards();
                });
            }
        });

        // Datadog Logs Functions
        async function searchDatadogLogs() {
            try {
                const query = document.getElementById('datadog-query').value || '*';
                const service = document.getElementById('datadog-service').value || '';
                const level = document.getElementById('datadog-level').value || '';
                const hours = document.getElementById('datadog-hours').value || 24;
                const limit = document.getElementById('datadog-limit').value || 100;
                
                // Show loading state
                const container = document.getElementById('datadog-logs-container');
                container.innerHTML = `
                    <div class="text-center" style="padding: 40px;">
                        <div style="background: #ff9800; width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);">
                            <i class="fas fa-spinner fa-spin fa-2x" style="color: white;"></i>
                        </div>
                        <h5 style="color: #333; margin-bottom: 10px; font-weight: 600;">Searching Logs...</h5>
                        <p style="color: #666;">Fetching data from Datadog</p>
                    </div>
                `;
                
                // Build query parameters
                const params = new URLSearchParams({
                    query: query,
                    hours: hours,
                    limit: limit
                });
                
                if (service) {
                    params.append('service', service);
                }
                
                if (level) {
                    params.append('level', level);
                }
                
                const response = await fetch(`/api/datadog/logs?${params}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayDatadogLogs(result.data);
                    // Also fetch and display statistics
                    await loadDatadogStats(query, service, level, hours);
                } else {
                    container.innerHTML = `
                        <div class="alert alert-danger" style="background: #ffebee; border: 1px solid #f44336; color: #c62828; border-radius: 4px; padding: 15px;">
                            <i class="fas fa-exclamation-triangle fa-lg" style="color: #f44336;"></i>
                            <strong>Error: ${result.message}</strong>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error searching Datadog logs:', error);
                document.getElementById('datadog-logs-container').innerHTML = `
                    <div class="alert alert-danger" style="background: #ffebee; border: 1px solid #f44336; color: #c62828; border-radius: 4px; padding: 15px;">
                        <i class="fas fa-exclamation-triangle fa-lg" style="color: #f44336;"></i>
                        <strong>Error: ${error.message}</strong>
                    </div>
                `;
            }
        }
        
        function displayDatadogLogs(logs) {
            const container = document.getElementById('datadog-logs-container');
            
            if (!logs || logs.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none; color: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);">
                        <i class="fas fa-info-circle fa-lg"></i>
                        <strong>No logs found for the specified criteria.</strong>
                    </div>
                `;
                return;
            }
            
           let html = `
               <div class="alert alert-success" style="background: #e8f5e8; border: 1px solid #4caf50; color: #2e7d32; border-radius: 4px; padding: 15px; margin-bottom: 20px;">
                   <i class="fas fa-check-circle fa-lg" style="color: #4caf50;"></i>
                   <strong>Found ${logs.length} unique log entries</strong>
                   ${logs.length < 10 ? '<br><small>Showing all available logs for the selected criteria</small>' : ''}
               </div>
                ${logs.length < 5 ? `
                <div class="alert alert-info" style="background: #e3f2fd; border: 1px solid #2196f3; color: #1565c0; border-radius: 4px; padding: 15px; margin-bottom: 20px;">
                    <i class="fas fa-info-circle" style="color: #2196f3;"></i>
                    <strong>Low Log Volume:</strong> Only ${logs.length} unique logs found. Try expanding the time range or removing service filters to see more logs.
                </div>
                ` : ''}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Timestamp</th>
                                <th>Service</th>
                                <th>Level</th>
                                <th>Message</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            logs.forEach(log => {
                const timestamp = new Date(log.timestamp).toLocaleString();
                const service = log.service || 'N/A';
                const level = log.level || 'INFO';
                const message = log.message || 'No message';
                const source = log.source || 'N/A';
                
                // Truncate long messages
                const truncatedMessage = message.length > 200 ? message.substring(0, 200) + '...' : message;
                
                html += `
                    <tr>
                        <td><small>${timestamp}</small></td>
                        <td><span class="badge bg-primary">${service}</span></td>
                        <td><span class="badge bg-${getLevelColor(level)}">${level}</span></td>
                        <td><small>${truncatedMessage}</small></td>
                        <td><small>${source}</small></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function getLevelColor(level) {
            switch (level.toUpperCase()) {
                case 'ERROR': return 'danger';
                case 'WARN': return 'warning';
                case 'INFO': return 'info';
                case 'DEBUG': return 'secondary';
                default: return 'light';
            }
        }
        
        async function loadDatadogStats(query, service, level, hours) {
            try {
                const params = new URLSearchParams({
                    query: query,
                    hours: hours
                });
                
                if (service) {
                    params.append('service', service);
                }
                
                if (level) {
                    params.append('level', level);
                }
                
                const response = await fetch(`/api/datadog/logs/stats?${params}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayDatadogStats(result.data);
                }
                
            } catch (error) {
                console.error('Error loading Datadog stats:', error);
            }
        }
        
        function displayDatadogStats(stats) {
            const container = document.getElementById('datadog-stats-container');
            
            if (!stats) {
                container.innerHTML = '<p class="text-muted">No statistics available</p>';
                return;
            }
            
            let html = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-primary">${stats.total_logs || 0}</h5>
                                <p class="card-text">Total Logs</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-info">${stats.unique_services || 0}</h5>
                                <p class="card-text">Services</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-warning">${stats.error_count || 0}</h5>
                                <p class="card-text">Errors</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-success">${stats.warning_count || 0}</h5>
                                <p class="card-text">Warnings</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (stats.services && stats.services.length > 0) {
                html += `
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5>Logs by Service</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Service</th>
                                            <th>Count</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                stats.services.forEach(service => {
                    const percentage = stats.total_logs > 0 ? ((service.count / stats.total_logs) * 100).toFixed(1) : 0;
                    html += `
                        <tr>
                            <td>${service.name}</td>
                            <td>${service.count}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Load available services
        async function loadDatadogServices() {
            try {
                const hours = document.getElementById('datadog-hours').value || 24;
                const response = await fetch(`/api/datadog/services?hours=${hours}`);
                const result = await response.json();
                
                const serviceSelect = document.getElementById('datadog-service');
                
                if (result.status === 'success' && result.data.length > 0) {
                    // Clear existing options except "All Services"
                    serviceSelect.innerHTML = '<option value="">All Services</option>';
                    
                    // Add service options
                    result.data.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service;
                        option.textContent = service;
                        serviceSelect.appendChild(option);
                    });
                    
                    console.log(`Loaded ${result.data.length} services from Datadog`);
                } else {
                    serviceSelect.innerHTML = '<option value="">No services found</option>';
                }
                
            } catch (error) {
                console.error('Error loading services:', error);
                const serviceSelect = document.getElementById('datadog-service');
                serviceSelect.innerHTML = '<option value="">Error loading services</option>';
            }
        }
        
        // Test Datadog connection on tab load
        document.addEventListener('DOMContentLoaded', function() {
            const datadogTab = document.getElementById('datadog-logs-tab');
            if (datadogTab) {
                datadogTab.addEventListener('click', async function() {
                    // Test connection when tab is first clicked
                    try {
                        const response = await fetch('/api/datadog/test');
                        const result = await response.json();
                        
                        const statusElement = document.getElementById('datadog-status');
                        if (result.status === 'success') {
                            statusElement.textContent = 'Connected';
                            statusElement.className = 'text-success';
                            
                            // Load services when connection is successful
                            await loadDatadogServices();
                        } else {
                            statusElement.textContent = 'Connection Failed';
                            statusElement.className = 'text-danger';
                        }
                    } catch (error) {
                        document.getElementById('datadog-status').textContent = 'Connection Error';
                        document.getElementById('datadog-status').className = 'text-danger';
                    }
                });
            }
            
            // Reload services when hours selection changes
            const hoursSelect = document.getElementById('datadog-hours');
            if (hoursSelect) {
                hoursSelect.addEventListener('change', function() {
                    loadDatadogServices();
                });
            }
        });

        // Old chatbot functions removed - now using floating widget

        function setupChatEventListeners() {
            const sendBtn = document.getElementById('send-message-btn');
            const chatInput = document.getElementById('chat-input');
            
            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const dataSourceSelect = document.getElementById('data-source-select');
            const question = chatInput.value.trim();
            
            if (!question) return;
            
            // Add user message to chat
            addMessageToChat(question, 'user');
            
            // Clear input
            chatInput.value = '';
            
            // Show typing indicator
            const typingId = addTypingIndicator();
            
            try {
                // Get current context data based on selected source
                const contextData = await getCurrentContextData(dataSourceSelect.value);
                
                // Send to chatbot API
                const response = await fetch('/api/chatbot/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        data_source: dataSourceSelect.value,
                        context_data: contextData
                    })
                });
                
                const result = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator(typingId);
                
                if (result.status === 'success') {
                    addMessageToChat(result.response, 'bot');
                } else {
                    addMessageToChat(`Error: ${result.message}`, 'bot', true);
                }
                
            } catch (error) {
                removeTypingIndicator(typingId);
                addMessageToChat(`Error: ${error.message}`, 'bot', true);
            }
        }

        function addMessageToChat(message, sender, isError = false) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const icon = sender === 'user' ? 'fas fa-user' : 'fas fa-robot';
            const bgClass = isError ? 'bg-danger text-white' : (sender === 'user' ? 'bg-primary text-white' : 'bg-light');
            const textClass = isError ? 'text-white' : '';
            
            messageDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0">
                        <i class="${icon} ${sender === 'user' ? 'text-primary' : 'text-primary'}"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="${bgClass} p-3 rounded">
                            <strong>${sender === 'user' ? 'You' : 'AI Assistant'}:</strong> ${message}
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addTypingIndicator() {
            const chatMessages = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            const typingId = 'typing-' + Date.now();
            typingDiv.id = typingId;
            typingDiv.className = 'message bot-message';
            
            typingDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-robot text-primary"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="bg-light p-3 rounded">
                            <strong>AI Assistant:</strong> <span class="typing-indicator">Thinking...</span>
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return typingId;
        }

        function removeTypingIndicator(typingId) {
            const typingElement = document.getElementById(typingId);
            if (typingElement) {
                typingElement.remove();
            }
        }

        async function getCurrentContextData(dataSource) {
            try {
                let contextData = {};
                
                switch (dataSource) {
                    case 'datadog':
                        // Get current Datadog data
                        const datadogResponse = await fetch('/api/analytics?metrics=system.cpu.user&metrics=system.mem.used&hours=24');
                        if (datadogResponse.ok) {
                            const datadogData = await datadogResponse.json();
                            contextData = datadogData.data || {};
                        }
                        break;
                        
                    case 'github':
                        // Get current GitHub data
                        const githubResponse = await fetch('/api/github/prs?days=30');
                        if (githubResponse.ok) {
                            const githubData = await githubResponse.json();
                            contextData = githubData.data || {};
                        }
                        break;
                        
                    case 'azuredevops':
                        // Get current Azure DevOps data
                        const azureResponse = await fetch('/api/azuredevops/analytics?days=7&org=tr-tax&project=TaxProf');
                        if (azureResponse.ok) {
                            const azureData = await azureResponse.json();
                            contextData = azureData.data || {};
                        }
                        break;
                        
                    case 'figma':
                        // Get current Figma data
                        const figmaResponse = await fetch('/api/figma/analytics?days=30');
                        if (figmaResponse.ok) {
                            const figmaData = await figmaResponse.json();
                            contextData = figmaData.data || {};
                        }
                        break;
                        
                    default:
                        // Get data from all sources
                        const [datadogRes, githubRes, azureRes, figmaRes] = await Promise.allSettled([
                            fetch('/api/analytics?metrics=system.cpu.user&metrics=system.mem.used&hours=24'),
                            fetch('/api/github/prs?days=30'),
                            fetch('/api/azuredevops/analytics?days=7&org=tr-tax&project=TaxProf'),
                            fetch('/api/figma/analytics?days=30')
                        ]);
                        
                        contextData = {
                            datadog: datadogRes.status === 'fulfilled' ? (await datadogRes.value.json()).data : null,
                            github: githubRes.status === 'fulfilled' ? (await githubRes.value.json()).data : null,
                            azuredevops: azureRes.status === 'fulfilled' ? (await azureRes.value.json()).data : null,
                            figma: figmaRes.status === 'fulfilled' ? (await figmaRes.value.json()).data : null
                        };
                        break;
                }
                
                return contextData;
                
            } catch (error) {
                console.error('Error getting context data:', error);
                return {};
            }
        }

        async function loadSuggestedQuestions() {
            try {
                const response = await fetch('/api/chatbot/suggest-questions/general', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        available_data: { sources: ['datadog', 'github', 'azuredevops', 'figma'] }
                    })
                });
                
                const result = await response.json();
                const container = document.getElementById('suggested-questions');
                
                if (result.status === 'success' && result.questions) {
                    container.innerHTML = '';
                    result.questions.forEach(question => {
                        const questionDiv = document.createElement('div');
                        questionDiv.className = 'mb-2';
                        questionDiv.innerHTML = `
                            <button class="btn btn-outline-secondary btn-sm w-100 text-start" onclick="askQuestion('${question.replace(/'/g, "\\'")}')">
                                <i class="fas fa-question-circle"></i> ${question}
                            </button>
                        `;
                        container.appendChild(questionDiv);
                    });
                } else {
                    container.innerHTML = '<div class="text-muted">No suggestions available</div>';
                }
                
            } catch (error) {
                console.error('Error loading suggested questions:', error);
                document.getElementById('suggested-questions').innerHTML = '<div class="text-muted">Error loading suggestions</div>';
            }
        }

        // Old askQuestion function removed - now using floating widget
    </script>

    <!-- Floating AI Assistant Widget -->
    <div id="ai-assistant-widget" class="ai-widget">
        <!-- Chat Toggle Button -->
        <button id="ai-toggle-btn" class="ai-toggle-btn" title="AI Assistant">
            <i class="fas fa-robot"></i>
            <span class="ai-status-indicator" id="ai-status-indicator"></span>
        </button>

        <!-- Chat Panel -->
        <div id="ai-chat-panel" class="ai-chat-panel">
            <!-- Chat Header -->
            <div class="ai-chat-header">
                <div class="d-flex align-items-center">
                    <i class="fas fa-robot text-primary me-2"></i>
                    <strong>AI Assistant</strong>
                    <span class="ai-status-badge ms-2" id="ai-status-badge">Ready</span>
                </div>
                <button id="ai-minimize-btn" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-minus"></i>
                </button>
            </div>

            <!-- Chat Messages -->
            <div id="ai-chat-messages" class="ai-chat-messages">
                <div class="ai-message ai-bot-message">
                    <div class="ai-message-content">
                        <i class="fas fa-robot text-primary me-2"></i>
                        <span>Hi! I can help analyze your analytics data. Ask me anything!</span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="ai-quick-actions">
                <button class="ai-quick-btn" onclick="askAIAssistant('Performance trends?')">
                    <i class="fas fa-chart-line"></i> Trends
                </button>
                <button class="ai-quick-btn" onclick="askAIAssistant('Issues summary?')">
                    <i class="fas fa-exclamation-triangle"></i> Issues
                </button>
                <button class="ai-quick-btn" onclick="askAIAssistant('Recent activity?')">
                    <i class="fas fa-clock"></i> Recent
                </button>
            </div>

            <!-- Chat Input -->
            <div class="ai-chat-input">
                <div class="input-group">
                    <select class="form-select form-select-sm" id="ai-data-source" style="max-width: 100px;">
                        <option value="general">All</option>
                        <option value="datadog">Datadog</option>
                        <option value="github">GitHub</option>
                        <option value="azuredevops">Azure DevOps</option>
                        <option value="figma">Figma</option>
                    </select>
                    <input type="text" class="form-control form-control-sm" id="ai-chat-input" placeholder="Ask about your data...">
                    <button class="btn btn-primary btn-sm" type="button" id="ai-send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Widget Styles -->
    <style>
        .ai-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .ai-toggle-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0,0,0,0.2);
        }

        .ai-status-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .ai-chat-panel {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 420px;
            height: 600px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .ai-chat-panel.show {
            display: flex;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .ai-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-status-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
        }

        .ai-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .ai-message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
        }

        .ai-bot-message {
            justify-content: flex-start;
        }

        .ai-user-message {
            justify-content: flex-end;
        }

        .ai-message-content {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.5;
            font-weight: 400;
        }

        .ai-bot-message .ai-message-content {
            background: white;
            border: 1px solid #e9ecef;
            color: #333;
        }

        .ai-user-message .ai-message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .ai-quick-actions {
            padding: 10px 15px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .ai-quick-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 8px 14px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #495057;
            font-weight: 500;
        }

        .ai-quick-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .ai-chat-input {
            padding: 18px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .ai-chat-input .form-control {
            border-radius: 20px;
            border: 1px solid #dee2e6;
            font-size: 15px;
            padding: 10px 15px;
        }

        .ai-chat-input .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .ai-chat-input .btn {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .ai-chat-panel {
                width: 350px;
                height: 500px;
            }
            
            .ai-widget {
                bottom: 15px;
                right: 15px;
            }
        }
    </style>

    <!-- AI Widget JavaScript -->
    <script>
        // AI Widget functionality
        let aiWidgetOpen = false;
        let aiInitialized = false;

        document.addEventListener('DOMContentLoaded', function() {
            initializeAIWidget();
        });

        function initializeAIWidget() {
            const toggleBtn = document.getElementById('ai-toggle-btn');
            const chatPanel = document.getElementById('ai-chat-panel');
            const minimizeBtn = document.getElementById('ai-minimize-btn');
            const sendBtn = document.getElementById('ai-send-btn');
            const chatInput = document.getElementById('ai-chat-input');

            // Toggle chat panel
            toggleBtn.addEventListener('click', function() {
                if (aiWidgetOpen) {
                    closeAIChat();
                } else {
                    openAIChat();
                }
            });

            // Minimize chat panel
            minimizeBtn.addEventListener('click', function() {
                closeAIChat();
            });

            // Send message
            sendBtn.addEventListener('click', sendAIMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendAIMessage();
                }
            });

            // Initialize AI status
            checkAIStatus();
        }

        function openAIChat() {
            const chatPanel = document.getElementById('ai-chat-panel');
            chatPanel.classList.add('show');
            aiWidgetOpen = true;
            
            // Focus input
            setTimeout(() => {
                document.getElementById('ai-chat-input').focus();
            }, 300);
        }

        function closeAIChat() {
            const chatPanel = document.getElementById('ai-chat-panel');
            chatPanel.classList.remove('show');
            aiWidgetOpen = false;
        }

        function sendAIMessage() {
            const input = document.getElementById('ai-chat-input');
            const dataSource = document.getElementById('ai-data-source').value;
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message
            addAIMessage(message, 'user');
            input.value = '';

            // Show typing indicator
            showAITyping();

            // Send to backend
            fetch('/api/chatbot/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: message,
                    data_source: dataSource
                })
            })
            .then(response => response.json())
            .then(data => {
                hideAITyping();
                if (data.status === 'success') {
                    addAIMessage(data.response, 'bot');
                } else {
                    addAIMessage('Sorry, I encountered an error. Please try again.', 'bot');
                }
            })
            .catch(error => {
                hideAITyping();
                addAIMessage('Sorry, I\'m having trouble connecting. Please try again.', 'bot');
            });
        }

        function addAIMessage(content, type) {
            const messagesContainer = document.getElementById('ai-chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ai-${type}-message`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'ai-message-content';
            
            if (type === 'bot') {
                contentDiv.innerHTML = `<i class="fas fa-robot text-primary me-2"></i>${content}`;
            } else {
                contentDiv.textContent = content;
            }
            
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showAITyping() {
            const messagesContainer = document.getElementById('ai-chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-message ai-bot-message';
            typingDiv.id = 'ai-typing-indicator';
            
            typingDiv.innerHTML = `
                <div class="ai-message-content">
                    <i class="fas fa-robot text-primary me-2"></i>
                    <span class="typing-dots">
                        <span>.</span><span>.</span><span>.</span>
                    </span>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideAITyping() {
            const typingIndicator = document.getElementById('ai-typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function askAIAssistant(question) {
            if (!aiWidgetOpen) {
                openAIChat();
            }
            document.getElementById('ai-chat-input').value = question;
            sendAIMessage();
        }

        function checkAIStatus() {
            fetch('/api/chatbot/status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const status = data.data;
                        const indicator = document.getElementById('ai-status-indicator');
                        const badge = document.getElementById('ai-status-badge');
                        
                        if (status.ready) {
                            indicator.style.background = '#28a745';
                            badge.textContent = 'Ready';
                            badge.style.background = 'rgba(40, 167, 69, 0.2)';
                        } else {
                            indicator.style.background = '#ffc107';
                            badge.textContent = 'Configuring...';
                            badge.style.background = 'rgba(255, 193, 7, 0.2)';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking AI status:', error);
                });
        }
    </script>
                </div> <!-- End analyticsContent -->
            </div> <!-- End main-content -->
        </div> <!-- End row -->
    </div> <!-- End container-fluid -->
</body>
</html>
